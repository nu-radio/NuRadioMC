

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NuRadioMC.simulation.simulation &mdash; NuRadio 3.0.0-dev documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/styling.css?v=3350586d" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=79e5c74d"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../main.html" class="icon icon-home">
            NuRadio
              <img src="../../../_static/logo_small.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Introduction/pages/welcome_page.html">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../Introduction/pages/introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Introduction/pages/installation.html">Installing NuRadioMC / NuRadioReco</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/installation.html#requirements">Requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/installation.html#installation-using-pip">Installation using <code class="docutils literal notranslate"><span class="pre">pip</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/installation.html#development-version">Development version</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/installation.html#manual-installation">Manual installation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../Introduction/pages/installation.html#pip-installable-dependencies">Pip-installable dependencies</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../Introduction/pages/installation.html#core-dependencies">Core Dependencies</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../Introduction/pages/installation.html#optional-dependencies">Optional Dependencies</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../Introduction/pages/installation.html#not-pip-installable-packages">Not pip-installable packages</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../Introduction/pages/conventions.html">Some notes on conventions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/conventions.html#coordinates">Coordinates</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../Introduction/pages/conventions.html#default-coordinate-system">Default coordinate system</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Introduction/pages/conventions.html#points">Points</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Introduction/pages/conventions.html#angles">Angles</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Introduction/pages/conventions.html#directions">Directions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Introduction/pages/conventions.html#electic-fields">Electic Fields</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/conventions.html#units">Units</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/conventions.html#particle-types">Particle types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/conventions.html#fourier-transformations">Fourier transformations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../Introduction/pages/contributing.html">Contributing to NuRadioMC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/contributing.html#installing-nuradiomc-for-developers">Installing NuRadioMC for developers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/contributing.html#workflow">Workflow</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/contributing.html#coding-conventions">Coding conventions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../Introduction/pages/contributing.html#how-to">How to</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../Introduction/pages/contributing.html#writing-docstrings">Writing docstrings</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Introduction/pages/contributing.html#update-the-version-number-dependencies">Update the version number / dependencies</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../Introduction/pages/contributing.html#writing-additional-documentation">Writing additional documentation</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../Introduction/pages/contributing.html#compiling-the-documentation">Compiling the documentation</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../Introduction/pages/contributing.html#headings-and-text">Headings and text</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../Introduction/pages/contributing.html#lists">Lists</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../Introduction/pages/contributing.html#links-and-cross-references">Links and cross-references</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../Introduction/pages/contributing.html#showing-code">Showing code</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../NuRadioReco/pages/welcome_page.html">NuRadioReco Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html">Data Structure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#nur-files-and-how-to-use-them">.nur Files and How to Use Them</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#philosophy-and-basic-structure">Philosophy and Basic Structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#reading-and-writing-nur-files">Reading and Writing .nur Files</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#parameter-storage">Parameter Storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#list-of-data-classes">List of Data Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#event">Event</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#radio-shower">Radio Shower</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#simshower">SimShower</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#simemitter">SimEmitter</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#particle">Particle</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#station">Station</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#trigger">Trigger</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#simstation">SimStation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#basetrace">BaseTrace</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#electric-field">Electric Field</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#channel">Channel</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#hybrid-information">Hybrid Information</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#hybrid-shower">Hybrid Shower</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/event_structure.html#hybrid-detector">Hybrid Detector</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../NuRadioReco/pages/detector_tree.html">Detector Description</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html">Detector Description</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#the-detector-class">The Detector Class</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#detector-description-formats">Detector Description Formats</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#database">DataBase</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#json">JSON</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#dictionary">Dictionary</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#signal-chain-responses">Signal Chain Responses</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#genericdetector">GenericDetector</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#event-specific-changes">Event-Specific Changes</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#detector-description-in-event-files">Detector Description in Event Files</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#writing-the-detector">Writing the Detector</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#reading-the-detector">Reading the Detector</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector.html#detector-viewer">Detector Viewer</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector_database_fields.html">Properties of Detector Description</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector_database_fields.html#antennas">Antennas</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector_database_fields.html#further-discussion-on-antenna-coordinates">Further Discussion on Antenna Coordinates</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/detector_database_fields.html#adc-table">ADC Table</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html">Antenna Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#implemetation-of-antenna-models">Implemetation of Antenna Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#overview-of-available-antenna-models">Overview of available Antenna Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#bicone-v8-infair">bicone_v8_InfAir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#bicone-v8-inffirn">bicone_v8_InfFirn</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#bicone-v8-inf-n1-32">bicone_v8_inf_n1.32</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#bicone-v8-inf-n1-4">bicone_v8_inf_n1.4</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#bicone-v8-inf-n1-78">bicone_v8_inf_n1.78</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-inffirn">createLPDA_100MHz_InfFirn</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-inffirn-n1-4">createLPDA_InfFirn_n1.4</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z1cm-infirn-rg">createLPDA_100MHz_z1cm_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z1cm-infirn-boresighttoboundary">createLPDA_100MHz_z1cm_InFirn_BoresightToBoundary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z10cm-infirn-rg">createLPDA_100MHz_z10cm_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z1m-infirn-rg">createLPDA_100MHz_z1m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z2m-infirn-rg">createLPDA_100MHz_z2m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z2m-infirn-backlobe-norg">createLPDA_100MHz_z2m_InFirn_Backlobe_NoRG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z3m-inair-rg">createLPDA_100MHz_z3m_InAir_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z3m-infirn-boresighttoboundary">createLPDA_100MHz_z3m_InFirn_BoresightToBoundary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z3mandlpdalen-infirn-boresighttoboundary">createLPDA_100MHz_z3mAndLPDALen_InFirn_BoresightToBoundary</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z5m-infirn-rg">createLPDA_100MHz_z5m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z10m-infirn-rg">createLPDA_100MHz_z10m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z100m-infirn-rg">createLPDA_100MHz_z100m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z200m-infirn-rg">createLPDA_100MHz_z200m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-infair">createLPDA_100MHz_InfAir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z1cm-inair-rg">createLPDA_100MHz_z1cm_InAir_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#createlpda-100mhz-z1m-infirn-rg-v2">createLPDA_100MHz_z1m_InFirn_RG_v2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-hpol-inffirn">dip7cm_hpol_infFirn</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z260mm-infirn-rg">dip7cm_z260mm_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z1m-infirn-rg">dip7cm_z1m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z2m-infirn-rg">dip7cm_z2m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z3m-infirn-rg-nearhorizontalhd">dip7cm_z3m_InFirn_RG_NearHorizontalHD</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z5m-infirn-rg">dip7cm_z5m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z10m-infirn-rg">dip7cm_z10m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z200m-infirn-rg">dip7cm_z200m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z100m-infirn-rg">dip7cm_z100m_InFirn_RG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-infair-s12">dip7cm_infAir_s12</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z270mm-inair">dip7cm_z270mm_InAir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z1m-inair">dip7cm_z1m_InAir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z1m-inair-rg-nearhorizontalhd">dip7cm_z1m_InAir_RG_NearHorizontalHD</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z1m-inair-rg-nearhorizontalhd2">dip7cm_z1m_InAir_RG_NearHorizontalHD2</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z2m-inair">dip7cm_z2m_InAir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dip7cm-z5m-inair">dip7cm_z5m_InAir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#rnog-vpol-4inch-center-n1-73">RNOG_vpol_4inch_center_n1.73</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#rnog-vpol-4inch-half-n1-73">RNOG_vpol_4inch_half_n1.73</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#rnog-vpol-4inch-wall-n1-73">RNOG_vpol_4inch_wall_n1.73</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#rnog-vpol-v2-5inch-center-n1-75">RNOG_vpol_v2_5inch_center_n1.75</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#rnog-quadslot-v1-n1-74">RNOG_quadslot_v1_n1.74</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#rnog-quadslot-v2-n1-74">RNOG_quadslot_v2_n1.74</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#rnog-quadslot-v2-rescaled-finefreq">RNOG_quadslot_v2_rescaled_fineFreq</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#rnog-quadslot-v3-air-rescaled-to-n1-74">RNOG_quadslot_v3_air_rescaled_to_n1.74</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#skala-inffirn">SKALA_InfFirn</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#additional-models">Additional Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#rnog-vpol-v1-n1-4">RNOG_vpol_v1_n1.4</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#rnog-vpol-v1-n1-73">RNOG_vpol_v1_n1.73</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#fourslot-inffirn">fourslot_InfFirn</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#greenland-vpol-inffirn">greenland_vpol_InfFirn</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#trislot-rnog">trislot_RNOG</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#dipole-ara-bicone-infinitefirn">dipole_ARA_bicone_infinitefirn</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#xfdtd-hpol-150mmhole-n1-78">XFDTD_Hpol_150mmHole_n1.78</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#xfdtd-vpol-crossfeed-150mmhole-n1-78">XFDTD_Vpol_CrossFeed_150mmHole_n1.78</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/antennamodels.html#xfdtd-vpol-crossfeed-150mmhole-n1-78-inffirn">XFDTD_Vpol_CrossFeed_150mmHole_n1.78_InfFirn</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/detector/rnog.html">The RNO-G detector class and database interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/rnog.html#detector-time-and-database-time">Detector time and database time</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/rnog.html#database-structure">Database structure</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/rnog.html#signal-chain">Signal Chain</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/rnog.html#response-class">Response class</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/detector/rnog.html#detector-class">Detector class</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../NuRadioReco/pages/times.html">Overview of times</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/times.html#station-time-event-time">Station time (Event time)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/times.html#trace-start-times-in-channels">Trace start times in channels</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/times.html#trace-start-times-in-e-fields">Trace start times in E-fields</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/times.html#trigger-times">Trigger times</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/times.html#overview-of-modules-that-affect-time">Overview of modules that affect time</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../NuRadioReco/pages/nur_modules.html">Modules</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/nur_modules.html#basic-module-structure">Basic Module Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/nur_modules.html#logging">Logging</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../NuRadioReco/pages/event_display.html">Event Display</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../NuRadioReco/pages/utilities.html">Utilities</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/utilities.html#unit-system">Unit System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/utilities.html#fourier-transformation">Fourier Transformation</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/utilities.html#metaclasses">Metaclasses</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/utilities.html#singleton">Singleton</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../NuRadioReco/pages/code_documentation.html">Code Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.html">NuRadioReco.framework package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.html#submodules">Submodules</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.base_shower.html">NuRadioReco.framework.base_shower module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.base_station.html">NuRadioReco.framework.base_station module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.base_trace.html">NuRadioReco.framework.base_trace module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.channel.html">NuRadioReco.framework.channel module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.electric_field.html">NuRadioReco.framework.electric_field module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.emitter.html">NuRadioReco.framework.emitter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.event.html">NuRadioReco.framework.event module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.hybrid_information.html">NuRadioReco.framework.hybrid_information module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.hybrid_shower.html">NuRadioReco.framework.hybrid_shower module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.parameter_storage.html">NuRadioReco.framework.parameter_storage module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.parameters.html">NuRadioReco.framework.parameters module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.particle.html">NuRadioReco.framework.particle module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.radio_shower.html">NuRadioReco.framework.radio_shower module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.sim_channel.html">NuRadioReco.framework.sim_channel module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.sim_emitter.html">NuRadioReco.framework.sim_emitter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.sim_station.html">NuRadioReco.framework.sim_station module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.station.html">NuRadioReco.framework.station module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.framework.trigger.html">NuRadioReco.framework.trigger module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.html">NuRadioReco.modules package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.html#subpackages">Subpackages</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.ARA.html">NuRadioReco.modules.ARA package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.ARIANNA.html">NuRadioReco.modules.ARIANNA package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.LOFAR.html">NuRadioReco.modules.LOFAR package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.RNO_G.html">NuRadioReco.modules.RNO_G package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.base.html">NuRadioReco.modules.base package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.custom.html">NuRadioReco.modules.custom package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.iftElectricFieldReconstructor.html">NuRadioReco.modules.iftElectricFieldReconstructor package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.io.html">NuRadioReco.modules.io package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.measured_noise.html">NuRadioReco.modules.measured_noise package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.neutrinoDirectionReconstructor.html">NuRadioReco.modules.neutrinoDirectionReconstructor package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.neutrinoVertexReconstructor.html">NuRadioReco.modules.neutrinoVertexReconstructor package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.phasedarray.html">NuRadioReco.modules.phasedarray package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.trigger.html">NuRadioReco.modules.trigger package</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.html#submodules">Submodules</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.analogToDigitalConverter.html">NuRadioReco.modules.analogToDigitalConverter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.beamFormingDirectionFitter.html">NuRadioReco.modules.beamFormingDirectionFitter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelAddCableDelay.html">NuRadioReco.modules.channelAddCableDelay module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelAntennaDedispersion.html">NuRadioReco.modules.channelAntennaDedispersion module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelBandPassFilter.html">NuRadioReco.modules.channelBandPassFilter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelCWNotchFilter.html">NuRadioReco.modules.channelCWNotchFilter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelGalacticNoiseAdder.html">NuRadioReco.modules.channelGalacticNoiseAdder module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelGenericNoiseAdder.html">NuRadioReco.modules.channelGenericNoiseAdder module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelLengthAdjuster.html">NuRadioReco.modules.channelLengthAdjuster module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelReadoutWindowCutter.html">NuRadioReco.modules.channelReadoutWindowCutter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelResampler.html">NuRadioReco.modules.channelResampler module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelSignalReconstructor.html">NuRadioReco.modules.channelSignalReconstructor module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelSinewaveSubtraction.html">NuRadioReco.modules.channelSinewaveSubtraction module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelStopFilter.html">NuRadioReco.modules.channelStopFilter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelTemplateCorrelation.html">NuRadioReco.modules.channelTemplateCorrelation module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelTimeOffsetCalculator.html">NuRadioReco.modules.channelTimeOffsetCalculator module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.channelTimeWindow.html">NuRadioReco.modules.channelTimeWindow module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.correlationDirectionFitter.html">NuRadioReco.modules.correlationDirectionFitter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.cosmicRayEnergyReconstructor.html">NuRadioReco.modules.cosmicRayEnergyReconstructor module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.efieldAirToIcePropagator.html">NuRadioReco.modules.efieldAirToIcePropagator module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.efieldRadioInterferometricReconstruction.html">NuRadioReco.modules.efieldRadioInterferometricReconstruction module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.efieldTimeDirectionFitter.html">NuRadioReco.modules.efieldTimeDirectionFitter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.efieldToVoltageConverter.html">NuRadioReco.modules.efieldToVoltageConverter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.efieldToVoltageConverterPerEfield.html">NuRadioReco.modules.efieldToVoltageConverterPerEfield module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.electricFieldBandPassFilter.html">NuRadioReco.modules.electricFieldBandPassFilter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.electricFieldResampler.html">NuRadioReco.modules.electricFieldResampler module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.electricFieldSignalReconstructor.html">NuRadioReco.modules.electricFieldSignalReconstructor module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.eventTypeIdentifier.html">NuRadioReco.modules.eventTypeIdentifier module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.sphericalWaveFitter.html">NuRadioReco.modules.sphericalWaveFitter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.templateDirectionFitter.html">NuRadioReco.modules.templateDirectionFitter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.voltageToAnalyticEfieldConverter.html">NuRadioReco.modules.voltageToAnalyticEfieldConverter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.voltageToEfieldConverter.html">NuRadioReco.modules.voltageToEfieldConverter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.voltageToEfieldConverterPerChannel.html">NuRadioReco.modules.voltageToEfieldConverterPerChannel module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.modules.voltageToEfieldConverterPerChannelGroup.html">NuRadioReco.modules.voltageToEfieldConverterPerChannelGroup module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.html">NuRadioReco.detector package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.html#subpackages">Subpackages</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.ARA.html">NuRadioReco.detector.ARA package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.ARIANNA.html">NuRadioReco.detector.ARIANNA package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.LOFAR.html">NuRadioReco.detector.LOFAR package</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.RNO_G.html">NuRadioReco.detector.RNO_G package</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.html#submodules">Submodules</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.amp.html">NuRadioReco.detector.amp module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.antennapattern.html">NuRadioReco.detector.antennapattern module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.detector.html">NuRadioReco.detector.detector module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.detector_base.html">NuRadioReco.detector.detector_base module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.detector_sql.html">NuRadioReco.detector.detector_sql module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.detector_sys_uncertainties.html">NuRadioReco.detector.detector_sys_uncertainties module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.filterresponse.html">NuRadioReco.detector.filterresponse module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.generic_detector.html">NuRadioReco.detector.generic_detector module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.response.html">NuRadioReco.detector.response module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.sql_to_json.html">NuRadioReco.detector.sql_to_json module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.test_detector_db.html">NuRadioReco.detector.test_detector_db module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.detector.visualize_detector.html">NuRadioReco.detector.visualize_detector module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.html">NuRadioReco.utilities package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.html#submodules">Submodules</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.analytic_pulse.html">NuRadioReco.utilities.analytic_pulse module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.bandpass_filter.html">NuRadioReco.utilities.bandpass_filter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.cr_flux.html">NuRadioReco.utilities.cr_flux module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.dataservers.html">NuRadioReco.utilities.dataservers module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.diodeSimulator.html">NuRadioReco.utilities.diodeSimulator module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.fft.html">NuRadioReco.utilities.fft module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.framework_utilities.html">NuRadioReco.utilities.framework_utilities module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.geometryUtilities.html">NuRadioReco.utilities.geometryUtilities module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.ice.html">NuRadioReco.utilities.ice module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.interferometry.html">NuRadioReco.utilities.interferometry module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.io_utilities.html">NuRadioReco.utilities.io_utilities module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.logging.html">NuRadioReco.utilities.logging module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.metaclasses.html">NuRadioReco.utilities.metaclasses module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.noise.html">NuRadioReco.utilities.noise module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.particle_names.html">NuRadioReco.utilities.particle_names module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.signal_processing.html">NuRadioReco.utilities.signal_processing module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.templates.html">NuRadioReco.utilities.templates module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.timing.html">NuRadioReco.utilities.timing module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.traceWindows.html">NuRadioReco.utilities.traceWindows module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.trace_utilities.html">NuRadioReco.utilities.trace_utilities module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.units.html">NuRadioReco.utilities.units module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.variableWindowSizeCorrelation.html">NuRadioReco.utilities.variableWindowSizeCorrelation module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioReco/apidoc/NuRadioReco.utilities.version.html">NuRadioReco.utilities.version module</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../NuRadioReco/pages/howto_documentation.html">Manuals</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/how_to/vertex_reconstruction.html">Use the Vertex Reconstruction Modules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/how_to/vertex_reconstruction.html#creating-lookup-tables">Creating Lookup Tables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/how_to/vertex_reconstruction.html#creating-electric-field-templates">Creating Electric Field Templates</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/how_to/vertex_reconstruction.html#d-vs-3d-vertex-reconstructor">2D vs. 3D Vertex Reconstructor</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioReco/pages/how_to/coreas_interpolation.html">Using the cosmic-ray pulse interpolator in NRR</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/how_to/coreas_interpolation.html#initialising-the-interpolator">Initialising the interpolator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/how_to/coreas_interpolation.html#interpolating-signals">Interpolating signals</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/how_to/coreas_interpolation.html#what-happens-when-you-initialise-a-signal-interpolator">What happens when you initialise a signal interpolator?</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioReco/pages/how_to/coreas_interpolation.html#some-tips-to-work-with-fluence-interpolation">Some tips to work with fluence interpolation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../NuRadioMC/pages/welcome_page.html">NuRadioMC Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../NuRadioMC/pages/HDF5_structure.html">HDF5 output structure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/HDF5_structure.html#opening-the-hdf5-file">Opening the HDF5 file</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/HDF5_structure.html#what-s-behind-the-hdf5-files">What’s behind the HDF5 files</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/HDF5_structure.html#hdf5-structure">HDF5 structure</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/HDF5_structure.html#hdf5-file-attributes">HDF5 file attributes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/HDF5_structure.html#hdf5-file-contents">HDF5 file contents</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/HDF5_structure.html#station-data">Station data</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../NuRadioMC/pages/code_documentation.html">Code Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.html">NuRadioMC.EvtGen package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.html#submodules">Submodules</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.NuRadioMCtoAraSim.html">NuRadioMC.EvtGen.NuRadioMCtoAraSim module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.NuRadioProposal.html">NuRadioMC.EvtGen.NuRadioProposal module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.create_tau_tab.html">NuRadioMC.EvtGen.create_tau_tab module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.generate_cylinder.html">NuRadioMC.EvtGen.generate_cylinder module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.generate_unforced.html">NuRadioMC.EvtGen.generate_unforced module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.generator.html">NuRadioMC.EvtGen.generator module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.generator_ASCII.html">NuRadioMC.EvtGen.generator_ASCII module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.generator_skeleton.html">NuRadioMC.EvtGen.generator_skeleton module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.hdf5_to_ASCII.html">NuRadioMC.EvtGen.hdf5_to_ASCII module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.proposal_table_manager.html">NuRadioMC.EvtGen.proposal_table_manager module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.readARAEventList.html">NuRadioMC.EvtGen.readARAEventList module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.EvtGen.readEventList_ASCII.html">NuRadioMC.EvtGen.readEventList_ASCII module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalGen.html">NuRadioMC.SignalGen package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalGen.html#subpackages">Subpackages</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalGen.ARZ.html">NuRadioMC.SignalGen.ARZ package</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalGen.html#submodules">Submodules</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalGen.HCRB2017.html">NuRadioMC.SignalGen.HCRB2017 module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalGen.askaryan.html">NuRadioMC.SignalGen.askaryan module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalGen.emitter.html">NuRadioMC.SignalGen.emitter module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalGen.parametrizations.html">NuRadioMC.SignalGen.parametrizations module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalProp.html">NuRadioMC.SignalProp package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalProp.html#submodules">Submodules</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalProp.analyticraytracing.html">NuRadioMC.SignalProp.analyticraytracing module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalProp.directRayTracing.html">NuRadioMC.SignalProp.directRayTracing module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalProp.propagation.html">NuRadioMC.SignalProp.propagation module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalProp.propagation_base_class.html">NuRadioMC.SignalProp.propagation_base_class module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.SignalProp.radioproparaytracing.html">NuRadioMC.SignalProp.radioproparaytracing module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.html">NuRadioMC.simulation package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.html#submodules">Submodules</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.output_writer_hdf5.html">NuRadioMC.simulation.output_writer_hdf5 module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html">NuRadioMC.simulation.simulation module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.time_logger.html">NuRadioMC.simulation.time_logger module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.html">NuRadioMC.utilities package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.html#submodules">Submodules</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.Veff.html">NuRadioMC.utilities.Veff module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.attenuation.html">NuRadioMC.utilities.attenuation module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.cross_sections.html">NuRadioMC.utilities.cross_sections module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.dump_hdf5.html">NuRadioMC.utilities.dump_hdf5 module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.earth_attenuation.html">NuRadioMC.utilities.earth_attenuation module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.fluxes.html">NuRadioMC.utilities.fluxes module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.inelasticities.html">NuRadioMC.utilities.inelasticities module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.medium.html">NuRadioMC.utilities.medium module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.medium_base.html">NuRadioMC.utilities.medium_base module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.merge_hdf5.html">NuRadioMC.utilities.merge_hdf5 module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.muon_flux.html">NuRadioMC.utilities.muon_flux module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.plotting.html">NuRadioMC.utilities.plotting module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.runner.html">NuRadioMC.utilities.runner module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.runner_example.html">NuRadioMC.utilities.runner_example module</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/apidoc/NuRadioMC.utilities.split_hdf5.html">NuRadioMC.utilities.split_hdf5 module</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../NuRadioMC/pages/manuals.html">Manuals</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/veff_tutorial.html">Example: Calculating effective volume</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/veff_tutorial.html#run-an-effective-volume-simulation">Run an effective volume simulation</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/veff_tutorial.html#generating-the-input-event-list">Generating the input event list</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/veff_tutorial.html#running-the-simulation">Running the simulation</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/veff_tutorial.html#visualization-of-results">Visualization of results</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/expected_sensitivities_tutorial.html">Example: Calculating expected sensitivities</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/example-multi_station_coincidences.html">Example: Multi-station coincidences</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/example-multi_station_coincidences.html#generation-of-detector-layout">1. Generation of detector layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/example-multi_station_coincidences.html#detector-simulation">2. Detector simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/example-multi_station_coincidences.html#running-the-simulation">3. Running the simulation</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/example-multi_station_coincidences.html#analyzing-the-output">4. Analyzing the output</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/event_generation.html">Event Generation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/event_generation.html#events-in-a-cylindrical-volume">Events in a cylindrical volume</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/event_generation.html#input-parameters">Input parameters</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/event_generation.html#data-sets-and-attributes">Data sets and attributes</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/event_generation.html#atmospheric-muons-generated-on-a-flat-surface">Atmospheric muons generated on a flat surface</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/event_generation.html#nuradioproposal-as-a-standalone-module">NuRadioProposal as a standalone module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_generation_shower.html">Signal Generation (from in-ice showers)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_generation_shower.html#frequency-domain-parameterisations">Frequency-domain parameterisations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_generation_shower.html#arz-semi-analytical-model">ARZ - semi-analytical model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_generation_shower.html#validity-of-the-parameterisations-and-the-arz-model">Validity of the parameterisations and the ARZ model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_generation_shower.html#timing">Timing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_generation_shower.html#using-the-same-shower-random-seed">Using the same shower. Random seed</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_generation_shower.html#fft-normalisation">FFT normalisation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_generation_emitter.html">Signal Generation (emitter)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_generation_emitter.html#spice-pulser">SPice Pulser</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_propagation.html">Signal Propagation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_propagation.html#propagation-module">Propagation module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_propagation.html#ray-tracing">Ray tracing</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_propagation.html#analytical-ray-tracer">Analytical ray tracer</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_propagation.html#radiopropa-numerical-ray-tracer-in-development">RadioPropa numerical ray tracer (in development)</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_propagation.html#example-scripts">Example scripts</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_propagation.html#how-to-calculate-an-analytic-ray-path">How to calculate an analytic ray path</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/signal_propagation.html#how-to-calculate-an-radiopropa-ray-path">How to calculate an radiopropa ray path</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html">Ice and attenuation models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#ice-model-implementation">Ice model implementation</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#the-icemodel-and-icemodel-simple-class">The IceModel and IceModel_Simple class</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#radiopropaicewrapper">RadioPropaIceWrapper</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#available-models-in-nuradiomc">Available models in NuRadioMC</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#simple-ice-models">Simple ice models</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#radiopropa-ice-models">RadioPropa ice models</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#attenuation-model">Attenuation model</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#using-specific-models">Using specific models</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#example-script">Example script</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#birefringence-ice-models">Birefringence Ice Models</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#available-birefringence-ice-models">Available Birefringence Ice Models</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#ice-flow-direction">Ice-Flow Direction</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#available-birefringence-propagation-options">Available Birefringence Propagation Options</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/icemodels.html#using-specific-birefringence-models">Using specific birefringence models</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/simulation_configuration.html">Simulation and configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/simulation_configuration.html#steering-files">Steering files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/simulation_configuration.html#config-files">Config files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/simulation_configuration.html#detector-description">Detector description</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/simulation_configuration.html#detector-simulation">Detector simulation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/running_on_a_cluster.html">Running on a cluster</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/running_on_a_cluster.html#generate-input-files">1. Generate input files</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/running_on_a_cluster.html#generate-job-sh-scripts">2. Generate job *.sh scripts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/running_on_a_cluster.html#submit-jobs-to-the-cluster">3. Submit jobs to the cluster</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../NuRadioMC/pages/Manuals/running_on_a_cluster.html#merge-individual-hdf5-output-files">4. Merge individual hdf5 output files</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../Experiments/welcome_page.html">Experiment-specific features</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../Experiments/lofar/overview.html">LOFAR</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../main.html">NuRadio</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../main.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">NuRadioMC.simulation.simulation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for NuRadioMC.simulation.simulation</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">yaml</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numpy.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">Philox</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">radiotools</span><span class="w"> </span><span class="kn">import</span> <span class="n">helper</span> <span class="k">as</span> <span class="n">hp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">radiotools</span><span class="w"> </span><span class="kn">import</span> <span class="n">coordinatesystems</span> <span class="k">as</span> <span class="n">cstrans</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioMC.utilities.medium</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">NuRadioMC.SignalGen</span><span class="w"> </span><span class="kn">import</span> <span class="n">askaryan</span><span class="p">,</span> <span class="n">emitter</span> <span class="k">as</span> <span class="n">emitter_signalgen</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">NuRadioMC.utilities.earth_attenuation</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_weight</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">NuRadioMC.SignalProp</span><span class="w"> </span><span class="kn">import</span> <span class="n">propagation</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">NuRadioMC.simulation.output_writer_hdf5</span><span class="w"> </span><span class="kn">import</span> <span class="n">outputWriterHDF5</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">NuRadioReco.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">NuRadioReco.utilities.logging</span><span class="w"> </span><span class="kn">import</span> <span class="n">LOGGING_STATUS</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.modules.io.eventWriter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.modules.channelAddCableDelay</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.modules.electricFieldResampler</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.modules.efieldToVoltageConverterPerEfield</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.modules.efieldToVoltageConverter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.modules.channelSignalReconstructor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.modules.channelResampler</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.modules.channelGenericNoiseAdder</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.modules.channelReadoutWindowCutter</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">NuRadioReco.detector</span><span class="w"> </span><span class="kn">import</span> <span class="n">detector</span><span class="p">,</span> <span class="n">antennapattern</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.framework.sim_station</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.framework.electric_field</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.framework.particle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.framework.event</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioReco.framework.sim_emitter</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">NuRadioReco.framework.parameters</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">electricFieldParameters</span> <span class="k">as</span> <span class="n">efp</span><span class="p">,</span> <span class="n">showerParameters</span> <span class="k">as</span> <span class="n">shp</span><span class="p">,</span>
    <span class="n">channelParameters</span> <span class="k">as</span> <span class="n">chp</span><span class="p">,</span> <span class="n">particleParameters</span> <span class="k">as</span> <span class="n">simp</span><span class="p">,</span> <span class="n">emitterParameters</span> <span class="k">as</span> <span class="n">ep</span><span class="p">,</span>
    <span class="n">generatorAttributes</span> <span class="k">as</span> <span class="n">genattrs</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">NuRadioMC.simulation.time_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;NuRadioMC.simulation&quot;</span><span class="p">)</span>


<span class="c1"># initialize a few NuRadioReco modules</span>
<span class="c1"># TODO: Is this the best way to do it? Better to initialize them on demand</span>

<span class="n">channelAddCableDelay</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">channelAddCableDelay</span><span class="o">.</span><span class="n">channelAddCableDelay</span><span class="p">()</span>
<span class="n">electricFieldResampler</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">electricFieldResampler</span><span class="o">.</span><span class="n">electricFieldResampler</span><span class="p">()</span>
<span class="n">efieldToVoltageConverterPerEfield</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">efieldToVoltageConverterPerEfield</span><span class="o">.</span><span class="n">efieldToVoltageConverterPerEfield</span><span class="p">()</span>
<span class="n">efieldToVoltageConverter</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">efieldToVoltageConverter</span><span class="o">.</span><span class="n">efieldToVoltageConverter</span><span class="p">()</span>
<span class="n">channelSignalReconstructor</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">channelSignalReconstructor</span><span class="o">.</span><span class="n">channelSignalReconstructor</span><span class="p">()</span>
<span class="n">channelResampler</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">channelResampler</span><span class="o">.</span><span class="n">channelResampler</span><span class="p">()</span>
<span class="n">channelGenericNoiseAdder</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">channelGenericNoiseAdder</span><span class="o">.</span><span class="n">channelGenericNoiseAdder</span><span class="p">()</span>
<span class="n">eventWriter</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">eventWriter</span><span class="o">.</span><span class="n">eventWriter</span><span class="p">()</span>
<span class="n">channelReadoutWindowCutter</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">channelReadoutWindowCutter</span><span class="o">.</span><span class="n">channelReadoutWindowCutter</span><span class="p">()</span>


<div class="viewcode-block" id="merge_config">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.merge_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">merge_config</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge the user configuration dictionary with the default configuration dictionary recursively.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    user : dict</span>
<span class="sd">        The user configuration dictionary.</span>
<span class="sd">    default : dict</span>
<span class="sd">        The default configuration dictionary.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The merged configuration dictionary.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">default</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
                <span class="n">user</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">user</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">merge_config</span><span class="p">(</span><span class="n">user</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">user</span></div>



<div class="viewcode-block" id="calculate_sim_efield">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.calculate_sim_efield">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_sim_efield</span><span class="p">(</span>
        <span class="n">showers</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span>
        <span class="n">det</span><span class="p">,</span> <span class="n">propagator</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span>
        <span class="n">time_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">min_efield_amplitude</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">distance_cut</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the simulated electric field for a given shower and channel.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    showers : list of showers</span>
<span class="sd">        A list of the showers that should be simulated (as defined in the input HDF5 file)</span>
<span class="sd">    station_id : int</span>
<span class="sd">        the station id, only needed to identify the correct channel in the detector description</span>
<span class="sd">    channel_id : int</span>
<span class="sd">        the channel id for which the electric field should be calculated as defined in the detector description</span>
<span class="sd">    det : Detector object</span>
<span class="sd">        the detector description defining all channels.</span>
<span class="sd">    propagator : propagator object</span>
<span class="sd">        the propagator that should be used to calculate the electric field from emitter to receiver, typically a ray tracer</span>
<span class="sd">    medium: medium object</span>
<span class="sd">        the medium in which the electric field is propagating, typically ice</span>
<span class="sd">    config : dict</span>
<span class="sd">        the NuRadioMC configuration dictionary (from the yaml file)</span>
<span class="sd">    time_logger: time_logger object</span>
<span class="sd">        the time logger to be used for the simulation</span>
<span class="sd">    min_efield_amplitude: float</span>
<span class="sd">        speedup cut: the minimum electric field amplitude, if all efields from all showers are below this threshold value</span>
<span class="sd">        the station will not be set as candidate station.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of SimEfield objects</span>
<span class="sd">        A list of SimEfield objects, one for each shower and propagation solution</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">distance_cut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;distance cut&#39;</span><span class="p">)</span>
        <span class="n">vertex_positions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">shower_energies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">shower</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">showers</span><span class="p">):</span>
            <span class="n">vertex_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shower</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">vertex</span><span class="p">))</span>
            <span class="n">shower_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shower</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">energy</span><span class="p">))</span>
        <span class="n">vertex_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vertex_positions</span><span class="p">)</span>
        <span class="n">shower_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shower_energies</span><span class="p">)</span>
        <span class="n">vertex_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vertex_positions</span> <span class="o">-</span> <span class="n">vertex_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;distance cut&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Calculating electric field for station </span><span class="si">%d</span><span class="s2"> , channel </span><span class="si">%d</span><span class="s2"> from list of showers&quot;</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>

    <span class="n">sim_station</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">sim_station</span><span class="o">.</span><span class="n">SimStation</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>
    <span class="n">sim_station</span><span class="o">.</span><span class="n">set_candidate</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">min_efield_amplitude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sim_station</span><span class="o">.</span><span class="n">set_candidate</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sim_station</span><span class="o">.</span><span class="n">set_is_neutrino</span><span class="p">()</span>  <span class="c1"># naming not ideal, but this function defines in-ice emission (compared to in-air emission from air showers)</span>

    <span class="n">x2</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">get_relative_position</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">det</span><span class="o">.</span><span class="n">get_absolute_position</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span>
    <span class="c1"># rescale the number of samples to the internal (higher) sampling rate used in the simulation</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">get_number_of_samples</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span> <span class="o">/</span> <span class="n">det</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># round to nearest even integer</span>

    <span class="k">for</span> <span class="n">iSh</span><span class="p">,</span> <span class="n">shower</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">showers</span><span class="p">):</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">shower</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">vertex</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">distance_cut</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;distance cut&#39;</span><span class="p">)</span>
            <span class="n">mask_shower_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vertex_distances</span> <span class="o">-</span> <span class="n">vertex_distances</span><span class="p">[</span><span class="n">iSh</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;distance_cut_sum_length&#39;</span><span class="p">]</span>
            <span class="n">shower_energy_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">shower_energies</span><span class="p">[</span><span class="n">mask_shower_sum</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">distance_cut</span><span class="p">(</span><span class="n">shower_energy_sum</span><span class="p">):</span>
                <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;distance cut&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;distance cut&#39;</span><span class="p">)</span>

        <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;ray tracing&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating electric field for shower </span><span class="si">{</span><span class="n">shower</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="si">}</span><span class="s2"> and station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2">, channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">shower_direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">shower</span><span class="o">.</span><span class="n">get_axis</span><span class="p">()</span> <span class="c1"># We need the propagation direction here, so we multiply the shower axis with &#39;-1&#39;</span>
        <span class="n">n_index</span> <span class="o">=</span> <span class="n">medium</span><span class="o">.</span><span class="n">get_index_of_refraction</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
        <span class="n">cherenkov_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">n_index</span><span class="p">)</span>

        <span class="n">propagator</span><span class="o">.</span><span class="n">set_start_and_end_point</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
        <span class="n">propagator</span><span class="o">.</span><span class="n">use_optional_function</span><span class="p">(</span><span class="s1">&#39;set_shower_axis&#39;</span><span class="p">,</span> <span class="n">shower_direction</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;redo_raytracing&#39;</span><span class="p">]:</span>  <span class="c1"># check if raytracing was already performed</span>
            <span class="k">pass</span>
            <span class="c1"># TODO: initiatlize ray tracer with existing results if available</span>
        <span class="n">propagator</span><span class="o">.</span><span class="n">find_solutions</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">propagator</span><span class="o">.</span><span class="n">has_solution</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;shower </span><span class="si">{</span><span class="n">shower</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="si">}</span><span class="s2"> and station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2">, channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">x1</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">x2</span><span class="si">}</span><span class="s2"> does not have any ray tracing solution&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_number_of_solutions</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;found </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> solutions for shower </span><span class="si">{</span><span class="n">shower</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="si">}</span><span class="s2"> and station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2">, channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">x1</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">x2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">delta_Cs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">viewing_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="c1"># loop through all ray tracing solution</span>
        <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">viewing_angles</span><span class="p">[</span><span class="n">iS</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">get_angle</span><span class="p">(</span><span class="n">shower_direction</span><span class="p">,</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_launch_vector</span><span class="p">(</span><span class="n">iS</span><span class="p">))</span>
            <span class="n">delta_Cs</span><span class="p">[</span><span class="n">iS</span><span class="p">]</span> <span class="o">=</span> <span class="n">viewing_angles</span><span class="p">[</span><span class="n">iS</span><span class="p">]</span> <span class="o">-</span> <span class="n">cherenkov_angle</span>
        <span class="c1"># discard event if delta_C (angle off cherenkov cone) is too large</span>
        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_Cs</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;delta_C_cut&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;delta_C too large, event unlikely to be observed, (min(Delta_C) = </span><span class="si">{</span><span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_Cs</span><span class="p">))</span><span class="o">/</span><span class="n">units</span><span class="o">.</span><span class="n">deg</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">deg), skipping event&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;ray tracing&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span> <span class="c1"># loop through all ray tracing solution</span>
            <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;ray tracing (time)&#39;</span><span class="p">)</span>
            <span class="c1"># skip individual channels where the viewing angle difference is too large</span>
            <span class="c1"># discard event if delta_C (angle off cherenkov cone) is too large</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_Cs</span><span class="p">[</span><span class="n">iS</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;delta_C_cut&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;delta_C too large, ray tracing solution unlikely to be observed, skipping ray tracing solution&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># TODO: Fill with previous values if RT was already performed</span>
            <span class="n">wave_propagation_distance</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_path_length</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>  <span class="c1"># calculate path length</span>
            <span class="n">wave_propagation_time</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_travel_time</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>  <span class="c1"># calculate travel time</span>
            <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;ray tracing (time)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wave_propagation_distance</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">wave_propagation_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;travel distance or travel time could not be calculated, skipping ray tracing solution. &#39;</span>
                               <span class="sa">f</span><span class="s1">&#39;Shower ID: </span><span class="si">{</span><span class="n">shower</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="si">}</span><span class="s1"> Station ID: </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s1"> Channel ID: </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># if the input file specifies a specific shower realization, or</span>
            <span class="c1"># if the shower was already simulated (e.g. for a different channel or ray tracing solution)</span>
            <span class="c1"># use that realization</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ARZ2019&quot;</span><span class="p">,</span> <span class="s2">&quot;ARZ2020&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">shower</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">charge_excess_profile_id</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;iN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">charge_excess_profile_id</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reusing shower </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;iN&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ARZ shower library&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Alvarez2009&quot;</span> <span class="ow">and</span> <span class="n">shower</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">k_L</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;k_L&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">k_L</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reusing k_L parameter of Alvarez2009 model of k_L = </span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;k_L&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;signal generation&#39;</span><span class="p">)</span>
            <span class="n">spectrum</span><span class="p">,</span> <span class="n">additional_output</span> <span class="o">=</span> <span class="n">askaryan</span><span class="o">.</span><span class="n">get_frequency_spectrum</span><span class="p">(</span><span class="n">shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">energy</span><span class="p">],</span> <span class="n">viewing_angles</span><span class="p">[</span><span class="n">iS</span><span class="p">],</span>
                            <span class="n">n_samples</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">type</span><span class="p">],</span> <span class="n">n_index</span><span class="p">,</span> <span class="n">wave_propagation_distance</span><span class="p">,</span>
                            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">],</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># save shower realization to SimShower and hdf5 file</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ARZ2019&quot;</span><span class="p">,</span> <span class="s2">&quot;ARZ2020&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">shower</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">charge_excess_profile_id</span><span class="p">):</span>
                    <span class="n">shower</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">charge_excess_profile_id</span><span class="p">,</span> <span class="n">additional_output</span><span class="p">[</span><span class="s1">&#39;iN&#39;</span><span class="p">])</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;setting shower profile for ARZ shower library to i = </span><span class="si">{</span><span class="n">additional_output</span><span class="p">[</span><span class="s1">&#39;iN&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Alvarez2009&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">shower</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">k_L</span><span class="p">):</span>
                    <span class="n">shower</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">k_L</span><span class="p">,</span> <span class="n">additional_output</span><span class="p">[</span><span class="s1">&#39;k_L&#39;</span><span class="p">])</span>

            <span class="n">polarization_direction_onsky</span> <span class="o">=</span> <span class="n">calculate_polarization_vector</span><span class="p">(</span><span class="n">shower_direction</span><span class="p">,</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_launch_vector</span><span class="p">(</span><span class="n">iS</span><span class="p">),</span> <span class="n">config</span><span class="p">)</span>
            <span class="n">receive_vector</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_receive_vector</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>
            <span class="n">eR</span><span class="p">,</span> <span class="n">eTheta</span><span class="p">,</span> <span class="n">ePhi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">polarization_direction_onsky</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">)</span>
            <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;signal generation&#39;</span><span class="p">)</span>

            <span class="c1"># this is common stuff which is the same between emitters and showers</span>
            <span class="n">electric_field</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">electric_field</span><span class="o">.</span><span class="n">ElectricField</span><span class="p">([</span><span class="n">channel_id</span><span class="p">],</span>
                                    <span class="n">position</span><span class="o">=</span><span class="n">det</span><span class="o">.</span><span class="n">get_relative_position</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">),</span>
                                    <span class="n">shower_id</span><span class="o">=</span><span class="n">shower</span><span class="o">.</span><span class="n">get_id</span><span class="p">(),</span> <span class="n">ray_tracing_id</span><span class="o">=</span><span class="n">iS</span><span class="p">)</span>
            <span class="n">electric_field</span><span class="o">.</span><span class="n">set_frequency_spectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">eR</span><span class="p">,</span> <span class="n">eTheta</span><span class="p">,</span> <span class="n">ePhi</span><span class="p">]),</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
            <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;propagation effects&#39;</span><span class="p">)</span>
            <span class="n">electric_field</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">apply_propagation_effects</span><span class="p">(</span><span class="n">electric_field</span><span class="p">,</span> <span class="n">iS</span><span class="p">)</span>
            <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;propagation effects&#39;</span><span class="p">)</span>
            <span class="c1"># Trace start time is equal to the interaction time relative to the first</span>
            <span class="c1"># interaction plus the wave travel time.</span>
            <span class="k">if</span> <span class="n">shower</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">shp</span><span class="o">.</span><span class="n">vertex_time</span><span class="p">):</span>
                <span class="n">trace_start_time</span> <span class="o">=</span> <span class="n">shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">vertex_time</span><span class="p">]</span> <span class="o">+</span> <span class="n">wave_propagation_time</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trace_start_time</span> <span class="o">=</span> <span class="n">wave_propagation_time</span>

            <span class="c1"># We shift the trace start time so that the trace time matches the propagation time.</span>
            <span class="c1"># The centre of the trace corresponds to the instant when the signal from the shower</span>
            <span class="c1"># vertex arrives at the observer. The next line makes sure that the centre time</span>
            <span class="c1"># of the trace is equal to vertex_time + T (wave propagation time)</span>
            <span class="n">trace_start_time</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">electric_field</span><span class="o">.</span><span class="n">get_number_of_samples</span><span class="p">()</span> <span class="o">/</span> <span class="n">electric_field</span><span class="o">.</span><span class="n">get_sampling_rate</span><span class="p">()</span>

            <span class="n">zenith</span><span class="p">,</span> <span class="n">azimuth</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">cartesian_to_spherical</span><span class="p">(</span><span class="o">*</span><span class="n">receive_vector</span><span class="p">)</span>
            <span class="n">electric_field</span><span class="o">.</span><span class="n">set_trace_start_time</span><span class="p">(</span><span class="n">trace_start_time</span><span class="p">)</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">azimuth</span><span class="p">]</span> <span class="o">=</span> <span class="n">azimuth</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">zenith</span><span class="p">]</span> <span class="o">=</span> <span class="n">zenith</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">ray_path_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">propagation</span><span class="o">.</span><span class="n">solution_types</span><span class="p">[</span><span class="n">propagator</span><span class="o">.</span><span class="n">get_solution_type</span><span class="p">(</span><span class="n">iS</span><span class="p">)]</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">nu_vertex_distance</span><span class="p">]</span> <span class="o">=</span> <span class="n">wave_propagation_distance</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">nu_vertex_propagation_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">wave_propagation_time</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">nu_viewing_angle</span><span class="p">]</span> <span class="o">=</span> <span class="n">viewing_angles</span><span class="p">[</span><span class="n">iS</span><span class="p">]</span>
            <span class="c1">#: electric field polarization in onsky-coordinates. 0 corresponds to polarization in e_theta, 90deg is polarization in e_phi</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">polarization_angle</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="o">*</span><span class="n">polarization_direction_onsky</span><span class="p">[</span><span class="mi">1</span><span class="p">:][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">raytracing_solution</span><span class="p">]</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_raytracing_output</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">launch_vector</span><span class="p">]</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_launch_vector</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">min_efield_amplitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">electric_field</span><span class="o">.</span><span class="n">get_trace</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="n">min_efield_amplitude</span><span class="p">:</span>
                    <span class="n">sim_station</span><span class="o">.</span><span class="n">set_candidate</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">sim_station</span><span class="o">.</span><span class="n">add_electric_field</span><span class="p">(</span><span class="n">electric_field</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Added electric field to SimStation for shower </span><span class="si">{</span><span class="n">shower</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="si">}</span><span class="s2"> and station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2"> with ray tracing solution </span><span class="si">{</span><span class="n">iS</span><span class="si">}</span><span class="s2"> and viewing angle </span><span class="si">{</span><span class="n">viewing_angles</span><span class="p">[</span><span class="n">iS</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">deg</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">deg&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sim_station</span></div>



<div class="viewcode-block" id="calculate_sim_efield_for_emitter">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.calculate_sim_efield_for_emitter">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_sim_efield_for_emitter</span><span class="p">(</span>
        <span class="n">emitters</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span>
        <span class="n">det</span><span class="p">,</span> <span class="n">propagator</span><span class="p">,</span> <span class="n">medium</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span>
        <span class="n">rnd</span><span class="p">,</span> <span class="n">antenna_pattern_provider</span><span class="p">,</span>
        <span class="n">time_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">min_efield_amplitude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the simulated electric field for a given shower and channel.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    emitters : list of emitters</span>
<span class="sd">        A list of the emitters that should be simulated (as defined in the input HDF5 file)</span>
<span class="sd">    station_id : int</span>
<span class="sd">        the station id, only needed to identify the correct channel in the detector description</span>
<span class="sd">    channel_id : int</span>
<span class="sd">        the channel id for which the electric field should be calculated as defined in the detector description</span>
<span class="sd">    det : Detector object</span>
<span class="sd">        the detector description defining all channels.</span>
<span class="sd">    propagator : propagator object</span>
<span class="sd">        the propagator that should be used to calculate the electric field from emitter to receiver, typically a ray tracer</span>
<span class="sd">    medium: medium object</span>
<span class="sd">        the medium in which the electric field is propagating, typically ice</span>
<span class="sd">    config : dict</span>
<span class="sd">        the NuRadioMC configuration dictionary (from the yaml file)</span>
<span class="sd">    rnd: numpy random number generator</span>
<span class="sd">        the random number generator to be used for the simulation</span>
<span class="sd">    antenna_pattern_provider: antenna pattern provider object</span>
<span class="sd">        the antenna pattern provider object to be used for the simulation</span>
<span class="sd">    time_logger: time_logger object</span>
<span class="sd">        the time logger to be used for the simulation</span>
<span class="sd">    min_efield_amplitude: float</span>
<span class="sd">        speedup cut: the minimum electric field amplitude, if all efields from all showers are belwo this threshold value</span>
<span class="sd">        the station will not be set as candidate station.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of SimEfield objects</span>
<span class="sd">        A list of SimEfield objects, one for each shower and propagation solution</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating electric field for station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2">, channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2"> from list of emitters&quot;</span><span class="p">)</span>

    <span class="n">sim_station</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">sim_station</span><span class="o">.</span><span class="n">SimStation</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>
    <span class="n">sim_station</span><span class="o">.</span><span class="n">set_is_neutrino</span><span class="p">()</span>  <span class="c1"># naming not ideal, but this function defines in-ice emission (compared to in-air emission from air showers)</span>
    <span class="n">sim_station</span><span class="o">.</span><span class="n">set_candidate</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">min_efield_amplitude</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sim_station</span><span class="o">.</span><span class="n">set_candidate</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">x2</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">get_relative_position</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">det</span><span class="o">.</span><span class="n">get_absolute_position</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span>
    <span class="c1"># rescale the number of samples to the internal (higher) sampling rate used in the simulation</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">get_number_of_samples</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span> <span class="o">/</span> <span class="n">det</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># round to nearest even integer</span>

    <span class="k">for</span> <span class="n">emitter</span> <span class="ow">in</span> <span class="n">emitters</span><span class="p">:</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;ray tracing&#39;</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">emitter</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="n">n_index</span> <span class="o">=</span> <span class="n">medium</span><span class="o">.</span><span class="n">get_index_of_refraction</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>

        <span class="n">propagator</span><span class="o">.</span><span class="n">set_start_and_end_point</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;redo_raytracing&#39;</span><span class="p">]:</span>  <span class="c1"># check if raytracing was already performed</span>
            <span class="k">pass</span>
            <span class="c1"># TODO: initiatlize ray tracer with existing results if available</span>
        <span class="n">propagator</span><span class="o">.</span><span class="n">find_solutions</span><span class="p">()</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;ray tracing&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">propagator</span><span class="o">.</span><span class="n">has_solution</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;emitter </span><span class="si">{</span><span class="n">emitter</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="si">}</span><span class="s2"> and station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">x1</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">x2</span><span class="si">}</span><span class="s2"> does not have any ray tracing solution&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_number_of_solutions</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">iS</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span> <span class="c1"># loop through all ray tracing solution</span>
            <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;ray tracing (time)&#39;</span><span class="p">)</span>
            <span class="c1"># TODO: Fill with previous values if RT was already performed</span>
            <span class="n">wave_propagation_distance</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_path_length</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>  <span class="c1"># calculate path length</span>
            <span class="n">wave_propagation_time</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_travel_time</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>  <span class="c1"># calculate travel time</span>
            <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;ray tracing (time)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wave_propagation_distance</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">wave_propagation_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;travel distance or travel time could not be calculated, skipping ray tracing solution. &#39;</span>
                            <span class="sa">f</span><span class="s1">&#39;Emitter ID: </span><span class="si">{</span><span class="n">emitter</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="si">}</span><span class="s1"> Station ID: </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s1"> Channel ID: </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># if the input file specifies a specific shower realization, or</span>
            <span class="c1"># if the shower was already simulated (e.g. for a different channel or ray tracing solution)</span>
            <span class="c1"># use that realization</span>
            <span class="n">amplitude</span> <span class="o">=</span> <span class="n">emitter</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">amplitude</span><span class="p">]</span>
            <span class="n">emitter_model</span> <span class="o">=</span> <span class="n">emitter</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">model</span><span class="p">]</span>
            <span class="n">emitter_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">emitter_kwargs</span><span class="p">[</span><span class="s2">&quot;launch_vector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_launch_vector</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ep</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">emitter</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                        <span class="n">emitter_kwargs</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">emitter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;signal generation&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">emitter_model</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;efield_&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">emitter_model</span> <span class="o">==</span> <span class="s2">&quot;efield_idl1_spice&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">emitter</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">realization_id</span><span class="p">):</span>
                        <span class="n">emitter_kwargs</span><span class="p">[</span><span class="s1">&#39;iN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">emitter</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">realization_id</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">emitter_kwargs</span><span class="p">[</span><span class="s1">&#39;rnd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rnd</span>

                <span class="p">(</span><span class="n">eR</span><span class="p">,</span> <span class="n">eTheta</span><span class="p">,</span> <span class="n">ePhi</span><span class="p">),</span> <span class="n">additional_output</span> <span class="o">=</span> <span class="n">emitter_signalgen</span><span class="o">.</span><span class="n">get_frequency_spectrum</span><span class="p">(</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">emitter_model</span><span class="p">,</span> <span class="o">**</span><span class="n">emitter_kwargs</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">emitter_model</span> <span class="o">==</span> <span class="s2">&quot;efield_idl1_spice&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">emitter</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">realization_id</span><span class="p">):</span>
                        <span class="n">emitter</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">realization_id</span><span class="p">,</span> <span class="n">additional_output</span><span class="p">[</span><span class="s1">&#39;iN&#39;</span><span class="p">])</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;setting emitter realization to i = </span><span class="si">{</span><span class="n">additional_output</span><span class="p">[</span><span class="s1">&#39;iN&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># the emitter fuction returns the voltage output of the pulser. We need to convole with the antenna response of the emitting antenna</span>
                <span class="c1"># to obtain the emitted electric field.</span>
                <span class="c1"># get emitting antenna properties</span>
                <span class="n">antenna_model</span> <span class="o">=</span> <span class="n">emitter</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">antenna_type</span><span class="p">]</span>
                <span class="n">antenna_pattern</span> <span class="o">=</span> <span class="n">antenna_pattern_provider</span><span class="o">.</span><span class="n">load_antenna_pattern</span><span class="p">(</span><span class="n">antenna_model</span><span class="p">)</span>
                <span class="n">ori</span> <span class="o">=</span> <span class="p">[</span><span class="n">emitter</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">orientation_theta</span><span class="p">],</span> <span class="n">emitter</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">orientation_phi</span><span class="p">],</span>
                       <span class="n">emitter</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">rotation_theta</span><span class="p">],</span> <span class="n">emitter</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">rotation_phi</span><span class="p">]]</span>
                <span class="c1"># source voltage given to the emitter</span>
                <span class="n">voltage_spectrum_emitter</span> <span class="o">=</span> <span class="n">emitter_signalgen</span><span class="o">.</span><span class="n">get_frequency_spectrum</span><span class="p">(</span><span class="n">amplitude</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>
                                                                            <span class="n">emitter_model</span><span class="p">,</span> <span class="o">**</span><span class="n">emitter_kwargs</span><span class="p">)</span>
                <span class="c1"># convolve voltage output with antenna response to obtain emitted electric field</span>
                <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftfreq</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
                <span class="n">zenith_emitter</span><span class="p">,</span> <span class="n">azimuth_emitter</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">cartesian_to_spherical</span><span class="p">(</span><span class="o">*</span><span class="n">propagator</span><span class="o">.</span><span class="n">get_launch_vector</span><span class="p">(</span><span class="n">iS</span><span class="p">))</span>
                <span class="n">VEL</span> <span class="o">=</span> <span class="n">antenna_pattern</span><span class="o">.</span><span class="n">get_antenna_response_vectorized</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">zenith_emitter</span><span class="p">,</span> <span class="n">azimuth_emitter</span><span class="p">,</span> <span class="o">*</span><span class="n">ori</span><span class="p">)</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">c</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">m</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">s</span>
                <span class="n">eTheta</span> <span class="o">=</span> <span class="n">VEL</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">voltage_spectrum_emitter</span> <span class="o">*</span> <span class="n">frequencies</span> <span class="o">*</span> <span class="n">n_index</span> <span class="o">/</span> <span class="n">c</span>
                <span class="n">ePhi</span> <span class="o">=</span> <span class="n">VEL</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">voltage_spectrum_emitter</span> <span class="o">*</span> <span class="n">frequencies</span> <span class="o">*</span> <span class="n">n_index</span> <span class="o">/</span> <span class="n">c</span>
                <span class="n">eR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">eTheta</span><span class="p">)</span>

            <span class="c1"># rescale amplitudes by 1/R, for emitters this is not part of the &quot;SignalGen&quot; class</span>
            <span class="n">eTheta</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">wave_propagation_distance</span>
            <span class="n">ePhi</span> <span class="o">*=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">wave_propagation_distance</span>
            <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;signal generation&#39;</span><span class="p">)</span>

            <span class="c1"># this is common stuff which is the same between emitters and showers. Make sure to do any changes to this code in both places</span>
            <span class="n">electric_field</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">electric_field</span><span class="o">.</span><span class="n">ElectricField</span><span class="p">([</span><span class="n">channel_id</span><span class="p">],</span>
                                    <span class="n">position</span><span class="o">=</span><span class="n">det</span><span class="o">.</span><span class="n">get_relative_position</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">),</span>
                                    <span class="n">shower_id</span><span class="o">=</span><span class="n">emitter</span><span class="o">.</span><span class="n">get_id</span><span class="p">(),</span> <span class="n">ray_tracing_id</span><span class="o">=</span><span class="n">iS</span><span class="p">)</span>
            <span class="n">electric_field</span><span class="o">.</span><span class="n">set_frequency_spectrum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">eR</span><span class="p">,</span> <span class="n">eTheta</span><span class="p">,</span> <span class="n">ePhi</span><span class="p">]),</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
            <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;propagation effects&#39;</span><span class="p">)</span>
            <span class="n">electric_field</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">apply_propagation_effects</span><span class="p">(</span><span class="n">electric_field</span><span class="p">,</span> <span class="n">iS</span><span class="p">)</span>
            <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;propagation effects&#39;</span><span class="p">)</span>
            <span class="c1"># Trace start time is equal to the emitter time in case one was defined</span>
            <span class="c1"># (relevant for multiple emitters per event group)</span>
            <span class="k">if</span> <span class="n">emitter</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">ep</span><span class="o">.</span><span class="n">time</span><span class="p">):</span>
                <span class="n">trace_start_time</span> <span class="o">=</span> <span class="n">emitter</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">time</span><span class="p">]</span> <span class="o">+</span> <span class="n">wave_propagation_time</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trace_start_time</span> <span class="o">=</span> <span class="n">wave_propagation_time</span>

            <span class="c1"># We shift the trace start time so that the trace time matches the propagation time.</span>
            <span class="c1"># The centre of the trace corresponds to the instant when the signal from the shower</span>
            <span class="c1"># vertex arrives at the observer. The next line makes sure that the centre time</span>
            <span class="c1"># of the trace is equal to vertex_time + wave_propagation_time (wave propagation time)</span>
            <span class="n">trace_start_time</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">electric_field</span><span class="o">.</span><span class="n">get_number_of_samples</span><span class="p">()</span> <span class="o">/</span> <span class="n">electric_field</span><span class="o">.</span><span class="n">get_sampling_rate</span><span class="p">()</span>

            <span class="n">zenith</span><span class="p">,</span> <span class="n">azimuth</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">cartesian_to_spherical</span><span class="p">(</span><span class="o">*</span><span class="n">propagator</span><span class="o">.</span><span class="n">get_receive_vector</span><span class="p">(</span><span class="n">iS</span><span class="p">))</span>
            <span class="n">electric_field</span><span class="o">.</span><span class="n">set_trace_start_time</span><span class="p">(</span><span class="n">trace_start_time</span><span class="p">)</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">azimuth</span><span class="p">]</span> <span class="o">=</span> <span class="n">azimuth</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">zenith</span><span class="p">]</span> <span class="o">=</span> <span class="n">zenith</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">ray_path_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">propagation</span><span class="o">.</span><span class="n">solution_types</span><span class="p">[</span><span class="n">propagator</span><span class="o">.</span><span class="n">get_solution_type</span><span class="p">(</span><span class="n">iS</span><span class="p">)]</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">nu_vertex_distance</span><span class="p">]</span> <span class="o">=</span> <span class="n">wave_propagation_distance</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">nu_vertex_propagation_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">wave_propagation_time</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">raytracing_solution</span><span class="p">]</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_raytracing_output</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>
            <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">launch_vector</span><span class="p">]</span> <span class="o">=</span> <span class="n">propagator</span><span class="o">.</span><span class="n">get_launch_vector</span><span class="p">(</span><span class="n">iS</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">min_efield_amplitude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">electric_field</span><span class="o">.</span><span class="n">get_trace</span><span class="p">()))</span> <span class="o">&gt;</span> <span class="n">min_efield_amplitude</span><span class="p">:</span>
                    <span class="n">sim_station</span><span class="o">.</span><span class="n">set_candidate</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">sim_station</span><span class="o">.</span><span class="n">add_electric_field</span><span class="p">(</span><span class="n">electric_field</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sim_station</span></div>



<div class="viewcode-block" id="apply_det_response_sim">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.apply_det_response_sim">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_det_response_sim</span><span class="p">(</span>
        <span class="n">sim_station</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span>
        <span class="n">detector_simulation_filter_amp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">evt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">event_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">detector_simulation_part1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">time_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the detector response to the simulated electric field, i.e., calculate the voltage traces as</span>
<span class="sd">    seen by the readout system, per shower, raytracing solution and channel.</span>
<span class="sd">    This includes the effect of the antenna response, the</span>
<span class="sd">    analog signal chain. The result is a list of SimChannel objects which are added to the</span>
<span class="sd">    SimStation object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sim_station : sim_station object that contains the electric fields at the observer positions</span>
<span class="sd">        A list of SimEfield objects, one for each shower and propagation solution</span>
<span class="sd">    det : Detector object</span>
<span class="sd">        the detector description defining all channels.</span>
<span class="sd">    config : dict</span>
<span class="sd">        the NuRadioMC configuration dictionary (from the yaml file)</span>
<span class="sd">    detector_simulation_filter_amp: function (optional)</span>
<span class="sd">        a function that applies the filter and amplifier response to the electric field</span>
<span class="sd">        the arguments to the function are (event, station, detector)</span>
<span class="sd">        if not provided, the function `detector_simulation_part1` needs to be provided.</span>
<span class="sd">    evt : NuRadioReco event object (optional)</span>
<span class="sd">        all NuRadioReco modules that get executed will be registered to the event.</span>
<span class="sd">        If no event is provided, a dummy event is created so that the function runs, but</span>
<span class="sd">        then this information is not available to the user.</span>
<span class="sd">    event_time: time object (optional)</span>
<span class="sd">        the time of the event to be simulated</span>
<span class="sd">    detector_simulation_part1: function (optional)</span>
<span class="sd">        this function gives the user the full flexibility to implement all processing</span>
<span class="sd">        arguments to the function are (event, station, detector)</span>

<span class="sd">    Returns nothing. The SimChannels are added to the SimStation object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">time_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;detector response (sim)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">evt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">event_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sim_station</span><span class="o">.</span><span class="n">set_station_time</span><span class="p">(</span><span class="n">event_time</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">detector_simulation_filter_amp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">detector_simulation_part1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No detector response function provided. Please provide either detector_simulation_filter_amp or detector_simulation_part1&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No detector response function provided. Please provide either detector_simulation_filter_amp or detector_simulation_part1&quot;</span><span class="p">)</span>

    <span class="c1"># convert efields to voltages at digitizer</span>
    <span class="k">if</span> <span class="n">detector_simulation_part1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">detector_simulation_part1</span><span class="p">(</span><span class="n">sim_station</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># convolve efield with antenna pattern and add cable delay (is not added with efieldToVoltageConverterPEREFIELD)</span>
        <span class="n">efieldToVoltageConverterPerEfield</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">sim_station</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>
        <span class="n">channelAddCableDelay</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">sim_station</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>

        <span class="n">detector_simulation_filter_amp</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">sim_station</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;amp_per_ray_solution&#39;</span><span class="p">]:</span>
        <span class="n">channelSignalReconstructor</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">sim_station</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;detector response (sim)&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="apply_det_response">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.apply_det_response">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_det_response</span><span class="p">(</span>
        <span class="n">evt</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span>
        <span class="n">detector_simulation_filter_amp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">add_noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">Vrms_per_channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">integrated_channel_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">noiseless_channels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">detector_simulation_part2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">time_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">channel_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the detector response to the simulated electric field, i.e., the voltage traces</span>
<span class="sd">    seen by the readout system. This function combines all electric fields (from different showers and</span>
<span class="sd">    ray tracing solutions) of one detector channel/antenna. This includes the effect of the antenna response, the</span>
<span class="sd">    analog signal chain. The result is a list of Channel objects which are added to the</span>
<span class="sd">    Station object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    evt : NuRadioReco.framework.event.Event</span>
<span class="sd">        Event object containing all the showers/emitters and electric fields</span>
<span class="sd">    det : Detector object</span>
<span class="sd">        the detector description defining all channels.</span>
<span class="sd">    config : dict</span>
<span class="sd">        the NuRadioMC configuration dictionary (from the yaml file)</span>
<span class="sd">    detector_simulation_filter_amp: function (optional)</span>
<span class="sd">        a function that applies the filter and amplifier response to the electric field</span>
<span class="sd">        the arguments to the function are (event, station, detector)</span>
<span class="sd">        if not provided, the function `detector_simulation_part2` needs to be provided.</span>
<span class="sd">    add_noise : bool</span>
<span class="sd">        if True, noise is added to the channels</span>
<span class="sd">    Vrms_per_channel : dict</span>
<span class="sd">        the noise RMS per channel</span>
<span class="sd">    integrated_channel_response : dict</span>
<span class="sd">        the integrated channels response int(S21^2, dt) per channel. Corresponds to bandwidth for signal</span>
<span class="sd">        chains without amplification. This is used to normalize the noise level</span>
<span class="sd">        to the bandwidth it is generated for.</span>
<span class="sd">    noiseless_channels : dict (keys station_id) of list of ints</span>
<span class="sd">        the channels that should not have noise added</span>
<span class="sd">    detector_simulation_part2: function (optional)</span>
<span class="sd">        this function gives the user the full flexibility to implement all processing</span>
<span class="sd">        arguments to the function are (event, station, detector)</span>
<span class="sd">    time_logger: time_logger object</span>
<span class="sd">        the time logger to be used for the simulation</span>
<span class="sd">    channel_ids: list of ints</span>
<span class="sd">        the channel ids for which the detector response should be calculated. If None, all channels are used.</span>

<span class="sd">    Returns nothing. The Channels are added to the Station object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">time_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;detector response&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">detector_simulation_filter_amp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">detector_simulation_part2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;No detector response function provided. Please provide either detector_simulation_filter_amp or detector_simulation_part2&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No detector response function provided. Please provide either detector_simulation_filter_amp or detector_simulation_part2&quot;</span><span class="p">)</span>

    <span class="n">station</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">get_station</span><span class="p">()</span>  <span class="c1"># will raise an error if there are more than one station, but this should never happen</span>
    <span class="c1"># convert efields to voltages at digitizer</span>
    <span class="k">if</span> <span class="n">detector_simulation_part2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">detector_simulation_part2</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">])</span>
        <span class="c1"># start detector simulation</span>

        <span class="c1"># convolve efield with antenna pattern and add cable delay (this is also done in the efieldToVoltageConverter</span>
        <span class="c1"># (unlike the efieldToVoltageConverterPEREFIELD))</span>
        <span class="n">efieldToVoltageConverter</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">channel_ids</span><span class="o">=</span><span class="n">channel_ids</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">add_noise</span><span class="p">:</span>
            <span class="n">max_freq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">dt</span>
            <span class="n">Vrms</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="n">det</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(</span><span class="n">station</span><span class="o">.</span><span class="n">get_id</span><span class="p">()):</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">integrated_channel_response</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">get_id</span><span class="p">()][</span><span class="n">channel_id</span><span class="p">]</span>
                <span class="c1"># normalize noise level to the bandwidth its generated for</span>
                <span class="n">Vrms</span><span class="p">[</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">Vrms_per_channel</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">get_id</span><span class="p">()][</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm</span> <span class="o">/</span> <span class="n">max_freq</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

            <span class="n">channelGenericNoiseAdder</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">Vrms</span><span class="p">,</span> <span class="n">min_freq</span><span class="o">=</span><span class="mi">0</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">MHz</span><span class="p">,</span>
                <span class="n">max_freq</span><span class="o">=</span><span class="n">max_freq</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;rayleigh&#39;</span><span class="p">,</span>
                <span class="n">excluded_channels</span><span class="o">=</span><span class="n">noiseless_channels</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">get_id</span><span class="p">()])</span>

        <span class="n">detector_simulation_filter_amp</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;detector response&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="build_dummy_event">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.build_dummy_event">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_dummy_event</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">det</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds a dummy event for simulation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    station_id : int</span>
<span class="sd">        The station ID.</span>
<span class="sd">    det : Detector object</span>
<span class="sd">        The detector description defining all channels.</span>
<span class="sd">    config : dict</span>
<span class="sd">        The NuRadioMC configuration dictionary (from the yaml file)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    object: The built event object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">evt</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">sim_station</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">sim_station</span><span class="o">.</span><span class="n">SimStation</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>
    <span class="n">sim_station</span><span class="o">.</span><span class="n">set_is_neutrino</span><span class="p">()</span>  <span class="c1"># naming not ideal, but this function defines in-ice emission (compared to in-air emission from air showers)</span>

    <span class="n">dt</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span>
    <span class="c1"># rescale the number of samples to the internal (higher) sampling rate used in the simulation</span>
    <span class="n">channel_id</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(</span><span class="n">station_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">get_number_of_samples</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span> <span class="o">/</span> <span class="n">det</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>
    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_samples</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># round to nearest even integer</span>

    <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="n">det</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(</span><span class="n">station_id</span><span class="p">):</span>
        <span class="n">electric_field</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">electric_field</span><span class="o">.</span><span class="n">ElectricField</span><span class="p">([</span><span class="n">channel_id</span><span class="p">],</span>
                                    <span class="n">det</span><span class="o">.</span><span class="n">get_relative_position</span><span class="p">(</span><span class="n">sim_station</span><span class="o">.</span><span class="n">get_id</span><span class="p">(),</span> <span class="n">channel_id</span><span class="p">))</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="n">trace</span><span class="p">[</span><span class="n">n_samples</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">V</span>  <span class="c1"># set a signal that should satisfy any trigger and speedup cuts</span>
        <span class="n">trace</span><span class="p">[</span><span class="n">n_samples</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">V</span>
        <span class="n">electric_field</span><span class="o">.</span><span class="n">set_trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="p">),</span> <span class="n">trace</span><span class="p">,</span> <span class="n">trace</span><span class="p">]),</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
        <span class="n">electric_field</span><span class="o">.</span><span class="n">set_trace_start_time</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">azimuth</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">zenith</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">deg</span>
        <span class="n">electric_field</span><span class="p">[</span><span class="n">efp</span><span class="o">.</span><span class="n">ray_path_type</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sim_station</span><span class="o">.</span><span class="n">add_electric_field</span><span class="p">(</span><span class="n">electric_field</span><span class="p">)</span>

    <span class="n">station</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">station</span><span class="o">.</span><span class="n">Station</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>
    <span class="n">station</span><span class="o">.</span><span class="n">set_sim_station</span><span class="p">(</span><span class="n">sim_station</span><span class="p">)</span>
    <span class="n">evt</span><span class="o">.</span><span class="n">set_station</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">evt</span></div>



<div class="viewcode-block" id="build_NuRadioEvents_from_hdf5">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.build_NuRadioEvents_from_hdf5">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">build_NuRadioEvents_from_hdf5</span><span class="p">(</span><span class="n">fin</span><span class="p">,</span> <span class="n">fin_attrs</span><span class="p">,</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">time_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build NuRadioReco event structures from the input file</span>

<span class="sd">    The function automatically determines if a particle or an emitter is simulated and builds the</span>
<span class="sd">    corresponding event structure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fin : dict</span>
<span class="sd">        the input file data dictionary</span>
<span class="sd">    fin_attrs : dict</span>
<span class="sd">        the input file attributes dictionary</span>
<span class="sd">    idxs : list of ints</span>
<span class="sd">        the indices of the events that should be built</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    event_group : `NuRadioReco.framework.event.Event`</span>
<span class="sd">        an event group object containing the showers and particles or emitters</span>
<span class="sd">        the output should contain all relevant information from the hdf5 file (except the attributes)</span>
<span class="sd">        to perform a NuRadioMC simulation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">time_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;event builder (hdf5 -&gt; nur)&#39;</span><span class="p">)</span>

    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">event_group_id</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;event_group_ids&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span>
    <span class="n">event_group</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="n">event_group_id</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">)</span>
    <span class="c1"># add event generator info event</span>
    <span class="k">for</span> <span class="n">enum_entry</span> <span class="ow">in</span> <span class="n">genattrs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">enum_entry</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">fin_attrs</span><span class="p">:</span>
            <span class="n">event_group</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">enum_entry</span><span class="p">,</span> <span class="n">fin_attrs</span><span class="p">[</span><span class="n">enum_entry</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

    <span class="n">particle_mode</span> <span class="o">=</span> <span class="s2">&quot;simulation_mode&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fin_attrs</span> <span class="ow">or</span> <span class="n">fin_attrs</span><span class="p">[</span><span class="s1">&#39;simulation_mode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;emitter&quot;</span>
    <span class="k">if</span> <span class="n">particle_mode</span><span class="p">:</span>  <span class="c1"># first case: simulation of a particle interaction which produces showers</span>
        <span class="c1"># there is only one primary particle per event group</span>
        <span class="n">input_particle</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">particle</span><span class="o">.</span><span class="n">Particle</span><span class="p">(</span><span class="n">event_group_id</span><span class="p">)</span>
        <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">flavor</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;flavors&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span>
        <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">energy</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;energies&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span>
        <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">interaction_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;interaction_type&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span>
        <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">inelasticity</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;inelasticity&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span>
        <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">vertex</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fin</span><span class="p">[</span><span class="s1">&#39;xx&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">],</span>
                                                <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;yy&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">],</span>
                                                <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;zz&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]])</span>
        <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">zenith</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;zeniths&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span>
        <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">azimuth</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;azimuths&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span>
        <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">inelasticity</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;inelasticity&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span>
        <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">n_interaction</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;n_interaction&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span>
        <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">shower_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;shower_ids&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;n_interaction&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># parents before the neutrino and outgoing daughters without shower are currently not</span>
            <span class="c1"># simulated. The parent_id is therefore at the moment only rudimentarily populated.</span>
            <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">parent_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># primary does not have a parent</span>
        <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">vertex_time</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;vertex_times&#39;</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
            <span class="n">input_particle</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">vertex_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;vertex_times&#39;</span><span class="p">][</span><span class="n">parent_id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;The input file does not include vertex times, setting vertex time to zero. Vertices from the same event will not be time-ordered.&quot;</span><span class="p">)</span>
        <span class="n">event_group</span><span class="o">.</span><span class="n">add_particle</span><span class="p">(</span><span class="n">input_particle</span><span class="p">)</span>

        <span class="c1"># now loop over all showers and add them to the event group</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="n">vertex_time</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="s1">&#39;vertex_times&#39;</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">vertex_time</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;vertex_times&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>

            <span class="c1"># create NuRadioReco event structure</span>
            <span class="n">sim_shower</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">radio_shower</span><span class="o">.</span><span class="n">RadioShower</span><span class="p">(</span><span class="n">fin</span><span class="p">[</span><span class="s1">&#39;shower_ids&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
            <span class="c1"># save relevant neutrino properties</span>
            <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">zenith</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;zeniths&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">azimuth</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;azimuths&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">energy</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;shower_energies&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">flavor</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;flavors&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">interaction_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;interaction_type&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">n_interaction</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;n_interaction&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">vertex</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fin</span><span class="p">[</span><span class="s1">&#39;xx&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;yy&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;zz&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]])</span>
            <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">vertex_time</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertex_time</span>
            <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;shower_type&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;shower_realization_ARZ&#39;</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">charge_excess_profile_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;shower_realization_ARZ&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;shower_realization_Alvarez2009&#39;</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
                <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">k_L</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;shower_realization_Alvarez2009&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>

            <span class="c1"># TODO direct parent does not necessarily need to be the primary in general, but full</span>
            <span class="c1"># interaction chain is currently not populated in the input files.</span>
            <span class="n">sim_shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">parent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">event_group_id</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding shower </span><span class="si">{</span><span class="n">sim_shower</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="si">}</span><span class="s2"> to event group </span><span class="si">{</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">event_group</span><span class="o">.</span><span class="n">add_sim_shower</span><span class="p">(</span><span class="n">sim_shower</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># emitter mode: simulation of one or several artificial emitters</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="n">emitter_obj</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">sim_emitter</span><span class="o">.</span><span class="n">SimEmitter</span><span class="p">(</span><span class="n">fin</span><span class="p">[</span><span class="s1">&#39;shower_ids&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>  <span class="c1"># shower_id is equivalent to emitter_id in this case</span>
            <span class="n">emitter_obj</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">fin</span><span class="p">[</span><span class="s1">&#39;xx&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;yy&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">],</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;zz&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]])</span>
            <span class="n">emitter_obj</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;emitter_model&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">emitter_obj</span><span class="p">[</span><span class="n">ep</span><span class="o">.</span><span class="n">amplitude</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;emitter_amplitudes&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ep</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">emitter_obj</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;emitter_&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
                        <span class="n">emitter_obj</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s1">&#39;emitter_&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">event_group</span><span class="o">.</span><span class="n">add_sim_emitter</span><span class="p">(</span><span class="n">emitter_obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;event builder (hdf5 -&gt; nur)&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">event_group</span></div>



<div class="viewcode-block" id="get_config">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.get_config">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the configuration file and return the configuration dictionary.</span>

<span class="sd">    The configuration dictionary is a combination of the default configuration</span>
<span class="sd">    and the local configuration file. The local configuration file can override</span>
<span class="sd">    the default configuration.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config_file : string</span>
<span class="sd">        the path to the configuration file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cfg : dict</span>
<span class="sd">        the configuration dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_file_default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;config_default.yaml&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;reading default config from </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">config_file_default</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file_default</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ymlfile</span><span class="p">:</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ymlfile</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s1">&#39;reading local config overrides from </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">config_file</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">config_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ymlfile</span><span class="p">:</span>
            <span class="n">local_config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">ymlfile</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
            <span class="n">new_cfg</span> <span class="o">=</span> <span class="n">merge_config</span><span class="p">(</span><span class="n">local_config</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">new_cfg</span>

    <span class="k">return</span> <span class="n">cfg</span></div>



<div class="viewcode-block" id="calculate_polarization_vector">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.calculate_polarization_vector">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_polarization_vector</span><span class="p">(</span><span class="n">shower_axis</span><span class="p">,</span> <span class="n">launch_vector</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; calculates the polarization vector in spherical coordinates (eR, eTheta, ePhi)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    shower_axis: array-like</span>
<span class="sd">        shower axis in cartesian coordinates</span>
<span class="sd">    launch_vector: array-like</span>
<span class="sd">        launch vector in cartesian coordinates</span>
<span class="sd">    config: dict</span>
<span class="sd">        configuration dictionary</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array-like</span>
<span class="sd">        polarization vector in spherical coordinates (eR, eTheta, ePhi)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][</span><span class="s1">&#39;polarization&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">polarization_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">launch_vector</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">shower_axis</span><span class="p">,</span> <span class="n">launch_vector</span><span class="p">))</span>
        <span class="n">polarization_direction</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">polarization_direction</span><span class="p">)</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">cstrans</span><span class="o">.</span><span class="n">cstrafo</span><span class="p">(</span><span class="o">*</span><span class="n">hp</span><span class="o">.</span><span class="n">cartesian_to_spherical</span><span class="p">(</span><span class="o">*</span><span class="n">launch_vector</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cs</span><span class="o">.</span><span class="n">transform_from_ground_to_onsky</span><span class="p">(</span><span class="n">polarization_direction</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][</span><span class="s1">&#39;polarization&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
        <span class="n">ePhi</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][</span><span class="s1">&#39;ePhi&#39;</span><span class="p">])</span>
        <span class="n">eTheta</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ePhi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">eTheta</span><span class="p">,</span> <span class="n">ePhi</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][</span><span class="s1">&#39;polarization&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> for config.signal.polarization is not a valid option&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>



<div class="viewcode-block" id="increase_signal">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.increase_signal">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">increase_signal</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="n">factor</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    increase the signal of a simulated station by a factor of x</span>
<span class="sd">    this is e.g. used to approximate a phased array concept with a single antenna</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    channel_id: int or None</span>
<span class="sd">        if None, all available channels will be modified</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">channel_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">electric_field</span> <span class="ow">in</span> <span class="n">station</span><span class="o">.</span><span class="n">get_sim_station</span><span class="p">()</span><span class="o">.</span><span class="n">get_electric_fields</span><span class="p">():</span>
            <span class="n">electric_field</span><span class="o">.</span><span class="n">set_trace</span><span class="p">(</span><span class="n">electric_field</span><span class="o">.</span><span class="n">get_trace</span><span class="p">()</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">electric_field</span><span class="o">.</span><span class="n">get_sampling_rate</span><span class="p">())</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">sim_channels</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">get_sim_station</span><span class="p">()</span><span class="o">.</span><span class="n">get_electric_fields_for_channels</span><span class="p">([</span><span class="n">channel_id</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">sim_channel</span> <span class="ow">in</span> <span class="n">sim_channels</span><span class="p">:</span>
            <span class="n">sim_channel</span><span class="o">.</span><span class="n">set_trace</span><span class="p">(</span><span class="n">sim_channel</span><span class="o">.</span><span class="n">get_trace</span><span class="p">()</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sim_channel</span><span class="o">.</span><span class="n">get_sampling_rate</span><span class="p">())</span></div>



<div class="viewcode-block" id="calculate_particle_weight">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.calculate_particle_weight">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_particle_weight</span><span class="p">(</span><span class="n">event_group</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">fin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the (survival) propability of a neutrino reaching the simulation volume.</span>

<span class="sd">    Depending on the config settings, the weights is used from the input file, or</span>
<span class="sd">    calulated based on the Earth attenuation and cross section model defined in the config</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    event_group : EventGroup</span>
<span class="sd">        The event group containing the particle.</span>
<span class="sd">    idx : int</span>
<span class="sd">        The index of the particle in the event group.</span>
<span class="sd">    cfg : dict</span>
<span class="sd">        The configuration parameters.</span>
<span class="sd">    fin : dictionary</span>
<span class="sd">        the data part of the hdf5 input file</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        The weight of the particle.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function calculates the weight of a particle based on the given event group, particle index, and configuration parameters.</span>
<span class="sd">    The weight is determined based on the weight mode specified in the configuration parameters.</span>
<span class="sd">    If the weight mode is set to &quot;existing&quot;, the function checks if the input file contains weights and assigns the weight to the particle.</span>
<span class="sd">    If the weight mode is set to None, the weight is set to 1.</span>
<span class="sd">    Otherwise, the weight is calculated based on the particle&#39;s zenith, energy, flavor, weight mode, cross section type, vertex position, and azimuth.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">primary</span> <span class="o">=</span> <span class="n">event_group</span><span class="o">.</span><span class="n">get_primary</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">][</span><span class="s1">&#39;weight_mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;existing&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;weights&quot;</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
            <span class="n">primary</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">weight</span><span class="p">]</span> <span class="o">=</span> <span class="n">fin</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;config file specifies to use weights from the input hdf5 file but the input file does not contain this information.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">][</span><span class="s1">&#39;weight_mode&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">primary</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">weight</span><span class="p">][</span><span class="n">simp</span><span class="o">.</span><span class="n">weight</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">primary</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">weight</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_weight</span><span class="p">(</span>
            <span class="n">primary</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">zenith</span><span class="p">],</span>
            <span class="n">primary</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">energy</span><span class="p">],</span>
            <span class="n">primary</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">flavor</span><span class="p">],</span>
            <span class="n">mode</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">][</span><span class="s1">&#39;weight_mode&#39;</span><span class="p">],</span>
            <span class="n">cross_section_type</span><span class="o">=</span><span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;weights&#39;</span><span class="p">][</span><span class="s1">&#39;cross_section_type&#39;</span><span class="p">],</span>
            <span class="n">vertex_position</span><span class="o">=</span><span class="n">primary</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">vertex</span><span class="p">],</span>
            <span class="n">phi_nu</span><span class="o">=</span><span class="n">primary</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">azimuth</span><span class="p">])</span>
    <span class="c1"># all entries for the event for this primary get the calculated primary&#39;s weight</span>
    <span class="k">return</span> <span class="n">primary</span><span class="p">[</span><span class="n">simp</span><span class="o">.</span><span class="n">weight</span><span class="p">]</span></div>



<div class="viewcode-block" id="group_into_events">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.group_into_events">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">group_into_events</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">event_group</span><span class="p">,</span> <span class="n">particle_mode</span><span class="p">,</span> <span class="n">split_event_time_diff</span><span class="p">,</span>
                      <span class="n">zerosignal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">time_logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Group the signals from a station into multiple events based on signal arrival times.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    station : NuRadioReco.framework.station.Station</span>
<span class="sd">        The station object containing the signals.</span>
<span class="sd">    event_group : NuRadioMC.framework.event.Event</span>
<span class="sd">        The event group object containing all showers or emitters and other meta attributes</span>
<span class="sd">    particle_mode : bool</span>
<span class="sd">        Flag indicating whether the events are a particle simulations or not (i.e. an emitter simulation)</span>
<span class="sd">    split_event_time_diff : float</span>
<span class="sd">        The time difference threshold for splitting events.</span>
<span class="sd">    zerosignal : bool, optional</span>
<span class="sd">        Flag indicating whether to zero out the signals. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    events : list of NuRadioReco.framework.event.Event</span>
<span class="sd">        The list of events created from the grouped signals.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">time_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s1">&#39;group into events&#39;</span><span class="p">)</span>

    <span class="n">event_group_id</span> <span class="o">=</span> <span class="n">event_group</span><span class="o">.</span><span class="n">get_run_number</span><span class="p">()</span>
    <span class="n">start_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channel_identifiers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">station</span><span class="o">.</span><span class="n">get_sim_station</span><span class="p">()</span><span class="o">.</span><span class="n">iter_channels</span><span class="p">():</span>
        <span class="n">channel_identifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">get_unique_identifier</span><span class="p">())</span>
        <span class="n">start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">get_trace_start_time</span><span class="p">())</span>

    <span class="n">start_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">start_times</span><span class="p">)</span>
    <span class="n">start_times_sort</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">start_times</span><span class="p">)</span>
    <span class="n">delta_start_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">start_times</span><span class="p">[</span><span class="n">start_times_sort</span><span class="p">])</span>  <span class="c1"># this array is sorted in time</span>
    <span class="n">split_event_time_diff</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">split_event_time_diff</span><span class="p">)</span>

    <span class="n">iSplit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">delta_start_times</span> <span class="o">&gt;</span> <span class="n">split_event_time_diff</span><span class="p">)))</span>
    <span class="n">n_sub_events</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iSplit</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">n_sub_events</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;splitting event group id </span><span class="si">{</span><span class="n">event_group_id</span><span class="si">}</span><span class="s2"> into </span><span class="si">{</span><span class="n">n_sub_events</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;sub events because time separation larger than </span><span class="si">{</span><span class="n">split_event_time_diff</span><span class="o">/</span><span class="n">units</span><span class="o">.</span><span class="n">ns</span><span class="si">}</span><span class="s2">ns&quot;</span><span class="p">)</span>

    <span class="n">tmp_station</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iEvent</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sub_events</span><span class="p">):</span>
        <span class="n">iStart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">iStop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_identifiers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_sub_events</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">iEvent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">iStart</span> <span class="o">=</span> <span class="n">iSplit</span><span class="p">[</span><span class="n">iEvent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">iEvent</span> <span class="o">&lt;</span> <span class="n">n_sub_events</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">iStop</span> <span class="o">=</span> <span class="n">iSplit</span><span class="p">[</span><span class="n">iEvent</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">start_times_sort</span><span class="p">[</span><span class="n">iStart</span><span class="p">:</span> <span class="n">iStop</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n_sub_events</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">start_time</span> <span class="ow">in</span> <span class="n">start_times</span><span class="p">[</span><span class="n">indices</span><span class="p">]:</span>
                <span class="n">tmp</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_time</span><span class="o">/</span><span class="n">units</span><span class="o">.</span><span class="n">ns</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; ns&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;creating event </span><span class="si">{</span><span class="n">iEvent</span><span class="si">}</span><span class="s2"> of event group </span><span class="si">{</span><span class="n">event_group_id</span><span class="si">}</span><span class="s2"> ranging &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;from </span><span class="si">{</span><span class="n">iStart</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">iStop</span><span class="si">}</span><span class="s2"> with indices </span><span class="si">{</span><span class="n">indices</span><span class="si">}</span><span class="s2"> corresponding to signal times of </span><span class="si">{</span><span class="n">tmp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">evt</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="n">event_group_id</span><span class="p">,</span> <span class="n">iEvent</span><span class="p">)</span>  <span class="c1"># create new event</span>
        <span class="k">if</span> <span class="n">particle_mode</span><span class="p">:</span>
            <span class="c1"># add MC particles that belong to this (sub) event to event structure</span>
            <span class="c1"># add only primary for now, since full interaction chain is not typically in the input hdf5s</span>
            <span class="n">evt</span><span class="o">.</span><span class="n">add_particle</span><span class="p">(</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_primary</span><span class="p">())</span>  <span class="c1"># add primary particle to event</span>

        <span class="c1"># copy over generator information from temporary event to event</span>
        <span class="k">for</span> <span class="n">enum_entry</span> <span class="ow">in</span> <span class="n">genattrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event_group</span><span class="o">.</span><span class="n">has_parameter</span><span class="p">(</span><span class="n">enum_entry</span><span class="p">):</span>
                <span class="n">evt</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">enum_entry</span><span class="p">,</span> <span class="n">event_group</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="n">enum_entry</span><span class="p">))</span>

        <span class="n">station</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">station</span><span class="o">.</span><span class="n">Station</span><span class="p">(</span><span class="n">tmp_station</span><span class="o">.</span><span class="n">get_id</span><span class="p">())</span>
        <span class="n">sim_station</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">sim_station</span><span class="o">.</span><span class="n">SimStation</span><span class="p">(</span><span class="n">tmp_station</span><span class="o">.</span><span class="n">get_id</span><span class="p">())</span>
        <span class="n">sim_station</span><span class="o">.</span><span class="n">set_is_neutrino</span><span class="p">()</span>
        <span class="n">tmp_sim_station</span> <span class="o">=</span> <span class="n">tmp_station</span><span class="o">.</span><span class="n">get_sim_station</span><span class="p">()</span>
        <span class="n">shower_ids_of_sub_event</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">iCh</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">ch_uid</span> <span class="o">=</span> <span class="n">channel_identifiers</span><span class="p">[</span><span class="n">iCh</span><span class="p">]</span>
            <span class="n">shower_id</span> <span class="o">=</span> <span class="n">ch_uid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">shower_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shower_ids_of_sub_event</span><span class="p">:</span>
                <span class="n">shower_ids_of_sub_event</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shower_id</span><span class="p">)</span>
            <span class="n">sim_station</span><span class="o">.</span><span class="n">add_channel</span><span class="p">(</span><span class="n">tmp_sim_station</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">ch_uid</span><span class="p">))</span>
            <span class="n">efield_uid</span> <span class="o">=</span> <span class="p">([</span><span class="n">ch_uid</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">ch_uid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ch_uid</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>  <span class="c1"># the efield unique identifier has as first parameter an array of the channels it is valid for</span>
            <span class="k">for</span> <span class="n">efield</span> <span class="ow">in</span> <span class="n">tmp_sim_station</span><span class="o">.</span><span class="n">get_electric_fields</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">efield</span><span class="o">.</span><span class="n">get_unique_identifier</span><span class="p">()</span> <span class="o">==</span> <span class="n">efield_uid</span><span class="p">:</span>
                    <span class="n">sim_station</span><span class="o">.</span><span class="n">add_electric_field</span><span class="p">(</span><span class="n">efield</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding sim efield </span><span class="si">{</span><span class="n">efield_uid</span><span class="si">}</span><span class="s2"> to sim station&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">particle_mode</span><span class="p">:</span>
            <span class="c1"># add showers that contribute to this (sub) event to event structure</span>
            <span class="k">for</span> <span class="n">shower_id</span> <span class="ow">in</span> <span class="n">shower_ids_of_sub_event</span><span class="p">:</span>
                <span class="n">evt</span><span class="o">.</span><span class="n">add_sim_shower</span><span class="p">(</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_sim_shower</span><span class="p">(</span><span class="n">shower_id</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">shower_id</span> <span class="ow">in</span> <span class="n">shower_ids_of_sub_event</span><span class="p">:</span>
                <span class="n">evt</span><span class="o">.</span><span class="n">add_sim_emitter</span><span class="p">(</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_sim_emitter</span><span class="p">(</span><span class="n">shower_id</span><span class="p">))</span>

        <span class="n">station</span><span class="o">.</span><span class="n">set_sim_station</span><span class="p">(</span><span class="n">sim_station</span><span class="p">)</span>
        <span class="n">station</span><span class="o">.</span><span class="n">set_station_time</span><span class="p">(</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_event_time</span><span class="p">())</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">set_station</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">zerosignal</span><span class="p">):</span>
            <span class="n">increase_signal</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;created </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">events</span><span class="p">)</span><span class="si">}</span><span class="s2"> events from event group </span><span class="si">{</span><span class="n">event_group_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time_logger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s1">&#39;group into events&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">events</span></div>



<div class="viewcode-block" id="read_input_hdf5">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.read_input_hdf5">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_input_hdf5</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads input file into memory.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        The path to the input file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fin : dict</span>
<span class="sd">        A dictionary containing the data from the input file.</span>
<span class="sd">    fin_stations : dict</span>
<span class="sd">        A nested dictionary containing the station data from the input file.</span>
<span class="sd">    fin_attrs : dict</span>
<span class="sd">        A dictionary containing the attributes from the input file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fin_hdf5</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">fin</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fin_stations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fin_attrs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fin_hdf5</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">_hl</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">Group</span><span class="p">):</span>
            <span class="n">fin_stations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key2</span><span class="p">,</span> <span class="n">value2</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fin_stations</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">key2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">fin</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fin</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fin_hdf5</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">fin_attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">fin_hdf5</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fin</span><span class="p">,</span> <span class="n">fin_stations</span><span class="p">,</span> <span class="n">fin_attrs</span></div>



<div class="viewcode-block" id="remove_all_traces">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.remove_all_traces">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_all_traces</span><span class="p">(</span><span class="n">evt</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove all traces from the event.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    evt : NuRadioReco.framework.event.Event</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">evt</span><span class="o">.</span><span class="n">get_stations</span><span class="p">():</span>
        <span class="n">sim_station</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">get_sim_station</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">electric_field</span> <span class="ow">in</span> <span class="n">sim_station</span><span class="o">.</span><span class="n">get_electric_fields</span><span class="p">():</span>
            <span class="n">electric_field</span><span class="o">.</span><span class="n">_time_trace</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">electric_field</span><span class="o">.</span><span class="n">_frequency_spectrum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">sim_channel</span> <span class="ow">in</span> <span class="n">sim_station</span><span class="o">.</span><span class="n">iter_channels</span><span class="p">():</span>
            <span class="n">sim_channel</span><span class="o">.</span><span class="n">_time_trace</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sim_channel</span><span class="o">.</span><span class="n">_frequency_spectrum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">electric_field</span> <span class="ow">in</span> <span class="n">station</span><span class="o">.</span><span class="n">get_electric_fields</span><span class="p">():</span>
            <span class="n">electric_field</span><span class="o">.</span><span class="n">_time_trace</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">electric_field</span><span class="o">.</span><span class="n">_frequency_spectrum</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">station</span><span class="o">.</span><span class="n">iter_channels</span><span class="p">():</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">_time_trace</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">channel</span><span class="o">.</span><span class="n">_frequency_spectrum</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="simulation">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.simulation">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">simulation</span><span class="p">:</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">inputfilename</span><span class="p">,</span>
            <span class="n">outputfilename</span><span class="p">,</span>
            <span class="n">detectorfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">det</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">det_kwargs</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">outputfilenameNuRadioReco</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">evt_time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">config_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="n">LOGGING_STATUS</span><span class="p">,</span>
            <span class="n">default_detector_station</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">default_detector_channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">file_overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">write_detector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">event_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">log_level_propagation</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
            <span class="n">ice_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">trigger_channels</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        initialize the NuRadioMC end-to-end simulation</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inputfilename: string, or pair</span>
<span class="sd">            the path to the hdf5 file containing the list of neutrino events</span>
<span class="sd">            alternatively, the data and attributes dictionary can be passed directly to the method</span>
<span class="sd">        outputfilename: string</span>
<span class="sd">            specify hdf5 output filename.</span>
<span class="sd">        detectorfile: string</span>
<span class="sd">            path to the json file containing the detector description</span>
<span class="sd">        det: detector object</span>
<span class="sd">            Pass a detector class object</span>
<span class="sd">        det_kwargs: dict</span>
<span class="sd">            Pass arguments to the detector (only used when det == None)</span>
<span class="sd">        station_id: int</span>
<span class="sd">            the station id for which the simulation is performed. Must match a station</span>
<span class="sd">            defined in the detector description</span>
<span class="sd">        outputfilenameNuRadioReco: string or None</span>
<span class="sd">            outputfilename of NuRadioReco detector sim file, this file contains all</span>
<span class="sd">            waveforms of the triggered events</span>
<span class="sd">            default: None, i.e., no output file will be written which is useful for</span>
<span class="sd">            effective volume calculations</span>
<span class="sd">        debug: bool</span>
<span class="sd">            True activates debug mode, default False</span>
<span class="sd">        evt_time: datetime object</span>
<span class="sd">            the time of the events, default 1/1/2018</span>
<span class="sd">        config_file: string</span>
<span class="sd">            path to config file</span>
<span class="sd">        log_level: logging.LEVEL</span>
<span class="sd">            the log level</span>
<span class="sd">        default_detector_station: int or None</span>
<span class="sd">            DEPRECATED: Define reference stations in the detector JSON file instead</span>
<span class="sd">        default_detector_channel: int or None</span>
<span class="sd">            DEPRECATED: Define reference channels in the detector JSON file instead</span>
<span class="sd">        file_overwrite: bool</span>
<span class="sd">            True allows overwriting of existing files, default False</span>
<span class="sd">        write_detector: bool</span>
<span class="sd">            If true, the detector description is written into the .nur files along with the events</span>
<span class="sd">            default True</span>
<span class="sd">        event_list: None or list of ints</span>
<span class="sd">            if provided, only the event listed in this list are being simulated</span>
<span class="sd">        log_level_propagation: logging.LEVEL</span>
<span class="sd">            the log level of the propagation module</span>
<span class="sd">        ice_model: medium object (default None)</span>
<span class="sd">            allows to specify a custom ice model. This model is used if the config file specifies the ice model as &quot;custom&quot;.</span>
<span class="sd">        trigger_channels: list of ints or dict of list of ints</span>
<span class="sd">            list of channel ids that are used for the trigger (per station_id). If None, all channels are used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;write_mode&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Parameter write_mode is deprecated. Define the output format in the config file instead.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__trigger_channel_ids</span> <span class="o">=</span> <span class="n">trigger_channels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trigger_channel_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No trigger channels specified. All channels will be simulated even if they don&#39;t contribute to any trigger. &quot;</span>
                        <span class="s2">&quot;This can be inefficient. Processing time can be saved by specifying the trigger channels.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_level</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_level_ray_propagation</span> <span class="o">=</span> <span class="n">log_level_propagation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span> <span class="o">=</span> <span class="n">NuRadioMC</span><span class="o">.</span><span class="n">simulation</span><span class="o">.</span><span class="n">time_logger</span><span class="o">.</span><span class="n">timeLogger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># the config seeting None means a random seed. To have the simulation be reproducable, we generate a new</span>
            <span class="c1"># random seed once and save this seed to the config setting. If the simulation is rerun, we can get</span>
            <span class="c1"># the same random sequence.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_rnd</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span><span class="n">Philox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_outputfilename</span> <span class="o">=</span> <span class="n">outputfilename</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputfilename</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;hdf5 output file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputfilename</span><span class="si">}</span><span class="s2"> already exists&quot;</span>
            <span class="k">if</span> <span class="n">file_overwrite</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_outputfilenameNuRadioReco</span> <span class="o">=</span> <span class="n">outputfilenameNuRadioReco</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_evt_time</span> <span class="o">=</span> <span class="n">evt_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__write_detector</span> <span class="o">=</span> <span class="n">write_detector</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;setting event time to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">evt_time</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_group_list</span> <span class="o">=</span> <span class="n">event_list</span>

        <span class="c1"># initialize detector simulation modules</span>
        <span class="c1"># due to mostly historical reasons, the detector simulation is provided as protected member functions,</span>
        <span class="c1"># the user inherits from the simulation class and provides the detector simulation functions as protected</span>
        <span class="c1"># member functions. This has the advantage that the user has potential access to all internal member variables</span>
        <span class="c1"># of the simulation class and thereby full control. However, this is discouraged as it makes it difficult to assure</span>
        <span class="c1"># backwards compatibility.</span>
        <span class="c1"># The default behaviour is that the user provides a function that defines the signal chain (i.e. filter and amplifiers etc.)</span>
        <span class="c1"># and another function that defines the trigger.</span>
        <span class="c1"># The user can also provide a function that defines the full detector simulation (i.e. the signal chain and the trigger) including</span>
        <span class="c1"># how noise is added etc.</span>
        <span class="c1"># The user needs to either provide the functions `_detector_simulation_filter_amp` and `_detector_simulation_trigger` or</span>
        <span class="c1"># the function `_detector_simulation_part1` and `_detector_simulation_part2`.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_part1</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_detector_simulation_part1&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_part2</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_detector_simulation_part2&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_filter_amp</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_detector_simulation_filter_amp&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_trigger</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_detector_simulation_trigger&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Please provide both detector_simulation_filter_amp and detector_simulation_trigger or detector_simulation_part1 and detector_simulation_part2&quot;</span>
        <span class="k">if</span> <span class="p">(((</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_filter_amp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_trigger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span>
            <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_part1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_part2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span>
            <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_part1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_filter_amp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="c1"># Initialize detector</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_antenna_pattern_provider</span> <span class="o">=</span> <span class="n">antennapattern</span><span class="o">.</span><span class="n">AntennaPatternProvider</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">det</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;Detectorfile </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">detectorfile</span><span class="p">)))</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">json_filename</span><span class="o">=</span><span class="n">detectorfile</span><span class="p">,</span> <span class="n">default_station</span><span class="o">=</span><span class="n">default_detector_station</span><span class="p">,</span>
                              <span class="n">default_channel</span><span class="o">=</span><span class="n">default_detector_channel</span><span class="p">,</span> <span class="n">antenna_by_depth</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">det_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_det</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">Detector</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_det</span> <span class="o">=</span> <span class="n">det</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt_time</span><span class="p">)</span>

        <span class="c1"># initialize propagation module</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;propagation&#39;</span><span class="p">][</span><span class="s1">&#39;ice_model&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ice_model</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;ice model is set to &#39;custom&#39; in config file but no custom ice model is provided.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;ice model is set to &#39;custom&#39; in config file but no custom ice model is provided.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ice</span> <span class="o">=</span> <span class="n">ice_model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ice</span> <span class="o">=</span> <span class="n">NuRadioMC</span><span class="o">.</span><span class="n">utilities</span><span class="o">.</span><span class="n">medium</span><span class="o">.</span><span class="n">get_ice_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;propagation&#39;</span><span class="p">][</span><span class="s1">&#39;ice_model&#39;</span><span class="p">])</span>

        <span class="n">prop</span> <span class="o">=</span> <span class="n">propagation</span><span class="o">.</span><span class="n">get_propagation_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;propagation&#39;</span><span class="p">][</span><span class="s1">&#39;module&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_propagator</span> <span class="o">=</span> <span class="n">prop</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ice</span><span class="p">,</span>
            <span class="n">log_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_level_ray_propagation</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span>
            <span class="n">detector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_station_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">get_station_ids</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_ids_counter</span> <span class="o">=</span> <span class="p">{</span><span class="n">station_id</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">station_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_ids</span><span class="p">}</span> <span class="c1"># we initialize with -1 becaue we increment the counter before we use it the first time</span>

        <span class="c1"># print noise information</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;running with noise </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">])))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;setting signal to zero </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;signal&#39;</span><span class="p">][</span><span class="s1">&#39;zerosignal&#39;</span><span class="p">])))</span>
        <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;propagation&#39;</span><span class="p">][</span><span class="s1">&#39;focusing&#39;</span><span class="p">]):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;simulating signal amplification due to focusing of ray paths in the firn.&quot;</span><span class="p">)</span>

        <span class="c1">#### Input HDF5 block   TODO: Add option to start from nur files</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputfilename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reading input from </span><span class="si">{</span><span class="n">inputfilename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># we read in the full input file into memory at the beginning to limit io to the beginning and end of the run</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_stations</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span> <span class="o">=</span> <span class="n">read_input_hdf5</span><span class="p">(</span><span class="n">inputfilename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;getting input on-the-fly&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_inputfilename</span> <span class="o">=</span> <span class="s2">&quot;on-the-fly&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fin</span> <span class="o">=</span> <span class="n">inputfilename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span> <span class="o">=</span> <span class="n">inputfilename</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fin_stations</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># check if the input file contains events, if not save empty output file (for book keeping) and terminate simulation</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fin</span><span class="p">[</span><span class="s1">&#39;xx&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputfilename</span><span class="si">}</span><span class="s2"> is empty&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1">### END input HDF5 block</span>

        <span class="c1"># Perfom a dummy detector simulation to determine how the signals are filtered.</span>
        <span class="c1"># This variable stores the integrated channel response for each channel, i.e.</span>
        <span class="c1"># the integral of the squared signal chain response over all frequencies, int S21^2 df.</span>
        <span class="c1"># For a system without amplification, it is equivalent to the bandwidth of the system.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response_normalization</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_amplification_per_channel</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># first create dummy event and station with channels, run the signal chain,</span>
        <span class="c1"># and determine the integrated channel response (to be able to normalize the noise level)</span>
        <span class="k">for</span> <span class="n">station_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_ids</span><span class="p">:</span>

            <span class="n">evt</span> <span class="o">=</span> <span class="n">build_dummy_event</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">)</span>
            <span class="c1"># TODO: It seems to be sufficient to just apply the `detector_simulation_filter_amp` function to a dummy event</span>
            <span class="n">apply_det_response</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_filter_amp</span><span class="p">,</span>
                               <span class="n">add_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">detector_simulation_part2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_part2</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response_normalization</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_max_amplification_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(</span><span class="n">station_id</span><span class="p">):</span>
                <span class="n">ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">],</span> <span class="mi">10000</span><span class="p">)</span>
                <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">iter_modules</span><span class="p">(</span><span class="n">station_id</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;get_filter&quot;</span><span class="p">):</span>
                        <span class="n">filt</span> <span class="o">*=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_filter</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_max_amplification_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="n">mean_integrated_response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">filt</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># a factor of 100 corresponds to -40 dB in amplitude</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response_normalization</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_integrated_response</span>

                <span class="n">integrated_channel_response</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">filt</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ff</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrated_channel_response</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Station.channel </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2"> estimated bandwidth is &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">integrated_channel_response</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">mean_integrated_response</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">MHz</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> MHz&quot;</span><span class="p">)</span>
        <span class="c1">################################</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bandwidth</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>  <span class="c1"># get value of first station/channel key pair</span>

        <span class="n">noise_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger&#39;</span><span class="p">][</span><span class="s1">&#39;noise_temperature&#39;</span><span class="p">]</span>
        <span class="n">Vrms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;trigger&#39;</span><span class="p">][</span><span class="s1">&#39;Vrms&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">noise_temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Vrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Specifying noise temperature (set to </span><span class="si">{</span><span class="n">noise_temp</span><span class="si">}</span><span class="s2">) and Vrms (set to </span><span class="si">{</span><span class="n">Vrms</span><span class="si">}</span><span class="s2">) is not allowed).&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_channel</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_efield_per_channel</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_trigger_channel</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>  <span class="c1"># Only used for trigger channels in a custom trigger simulation (optional)</span>


        <span class="k">if</span> <span class="n">noise_temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">noise_temp</span> <span class="o">==</span> <span class="s2">&quot;detector&quot;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;Use noise temperature from detector description to determine noise Vrms in each channel.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_noise_temp</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># the noise temperature is defined in the detector description</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_noise_temp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">noise_temp</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Use a noise temperature of </span><span class="si">{</span><span class="n">noise_temp</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">kelvin</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> K for each channel to determine noise Vrms.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_noiseless_channels</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">station_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="p">[</span><span class="n">station_id</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noise_temp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">noise_temp_channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">get_noise_temperature</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">noise_temp_channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noise_temp</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">is_channel_noiseless</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_noiseless_channels</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel_id</span><span class="p">)</span>

                    <span class="c1"># Calculation of Vrms. For details see from elog:1566 and https://en.wikipedia.org/wiki/Johnson%E2%80%93Nyquist_noise</span>
                    <span class="c1"># (last two Eqs. in &quot;noise voltage and power&quot; section) or our wiki https://nu-radio.github.io/NuRadioMC/NuRadioMC/pages/HDF5_structure.html</span>

                    <span class="c1"># Bandwidth, i.e., \Delta f in equation</span>
                    <span class="n">integrated_channel_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span>
                    <span class="n">max_amplification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_amplification_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">noise_temp_channel</span> <span class="o">*</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="n">integrated_channel_response</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">Hz</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_efield_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">/</span> <span class="n">max_amplification</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">m</span>  <span class="c1"># VEL = 1m</span>

                    <span class="c1"># for logging</span>
                    <span class="n">mean_integrated_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response_normalization</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Station.channel </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">channel_id</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">: noise temperature = </span><span class="si">{</span><span class="n">noise_temp_channel</span><span class="si">}</span><span class="s1"> K, &#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;est. bandwidth = </span><span class="si">{</span><span class="n">integrated_channel_response</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">mean_integrated_response</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">MHz</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> MHz, &#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;max. filter amplification = </span><span class="si">{</span><span class="n">max_amplification</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> &#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;integrated response = </span><span class="si">{</span><span class="n">integrated_channel_response</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">MHz</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">MHz -&gt; Vrms = &#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">mV</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> mV -&gt; efield Vrms = &#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_efield_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">V</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">m</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">micro</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">muV/m (assuming VEL = 1m) &#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_channel</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="k">elif</span> <span class="n">Vrms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Vrms</span><span class="p">)</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">V</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_noise_temp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Use a fix noise Vrms of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_Vrms</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">mV</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> mV in each channel.&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">station_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="p">[</span><span class="n">station_id</span><span class="p">]:</span>
                    <span class="n">max_amplification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_amplification_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms</span>  <span class="c1"># to be stored in the hdf5 file</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_efield_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms</span> <span class="o">/</span> <span class="n">max_amplification</span> <span class="o">/</span> <span class="n">units</span><span class="o">.</span><span class="n">m</span>  <span class="c1"># VEL = 1m</span>

                    <span class="c1"># for logging</span>
                    <span class="n">integrated_channel_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span>
                    <span class="n">mean_integrated_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response_normalization</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Station.channel </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">channel_id</span><span class="si">:</span><span class="s1">02d</span><span class="si">}</span><span class="s1">: &#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;est. bandwidth = </span><span class="si">{</span><span class="n">integrated_channel_response</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">mean_integrated_response</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">MHz</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> MHz, &#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;max. filter amplification = </span><span class="si">{</span><span class="n">max_amplification</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1"> &#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;integrated response = </span><span class="si">{</span><span class="n">integrated_channel_response</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">MHz</span><span class="si">:</span><span class="s1">.2e</span><span class="si">}</span><span class="s1">MHz -&gt;&#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;efield Vrms = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_efield_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">V</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">m</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">units</span><span class="o">.</span><span class="n">micro</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">muV/m (assuming VEL = 1m) &#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;noise temperature and Vrms are both set to None&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_efield</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_efield_per_channel</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="n">speed_cut</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;min_efield_amplitude&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;All stations where all efields from all showers have amplitudes of less then </span><span class="si">{</span><span class="n">speed_cut</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> x Vrms_efield will be skipped.&quot;</span><span class="p">)</span>

        <span class="c1"># define function for distance speedup cut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_distance_cut</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;distance_cut&#39;</span><span class="p">]:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;distance_cut_coefficients&#39;</span><span class="p">]</span>
            <span class="n">distance_cut_polynomial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">Polynomial</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">get_distance_cut</span><span class="p">(</span><span class="n">shower_energy</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">shower_energy</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">m</span>
                <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">m</span><span class="p">,</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">distance_cut_polynomial</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">shower_energy</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_get_distance_cut</span> <span class="o">=</span> <span class="n">get_distance_cut</span>

        <span class="n">particle_mode</span> <span class="o">=</span> <span class="s2">&quot;simulation_mode&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s1">&#39;simulation_mode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;emitter&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_output_writer_hdf5</span> <span class="o">=</span> <span class="n">outputWriterHDF5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputfilename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_station_ids</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">_propagator</span><span class="o">.</span><span class="n">get_number_of_raytracing_solutions</span><span class="p">(),</span>
                                                    <span class="n">particle_mode</span><span class="o">=</span><span class="n">particle_mode</span><span class="p">)</span>

        <span class="n">efieldToVoltageConverter</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
        <span class="n">channelGenericNoiseAdder</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;seed&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputfilenameNuRadioReco</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eventWriter</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_outputfilenameNuRadioReco</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_log_level</span><span class="p">)</span>


<div class="viewcode-block" id="simulation.run">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.simulation.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        run the NuRadioMC simulation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fin</span><span class="p">[</span><span class="s1">&#39;xx&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;The input file does not contain any showers or emitters. Writing empty hdf5 output file.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_writer_hdf5</span><span class="o">.</span><span class="n">write_empty_output_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;terminating simulation&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;Starting NuRadioMC simulation&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="o">.</span><span class="n">reset_times</span><span class="p">()</span>

        <span class="n">particle_mode</span> <span class="o">=</span> <span class="s2">&quot;simulation_mode&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s1">&#39;simulation_mode&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;emitter&quot;</span>
        <span class="n">event_group_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fin</span><span class="p">[</span><span class="s1">&#39;event_group_ids&#39;</span><span class="p">])</span>
        <span class="n">unique_event_group_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">event_group_ids</span><span class="p">)</span>

        <span class="c1"># calculate bary centers of station</span>
        <span class="n">station_barycenter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_station_ids</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">iSt</span><span class="p">,</span> <span class="n">station_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_station_ids</span><span class="p">):</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(</span><span class="n">station_id</span><span class="p">):</span>
                <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">get_relative_position</span><span class="p">(</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">))</span>
            <span class="n">station_barycenter</span><span class="p">[</span><span class="n">iSt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">get_absolute_position</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>

        <span class="c1"># loop over event groups</span>
        <span class="k">for</span> <span class="n">i_event_group_id</span><span class="p">,</span> <span class="n">event_group_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_event_group_ids</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;simulating event group id </span><span class="si">{</span><span class="n">event_group_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_group_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">event_group_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_group_list</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skipping event group </span><span class="si">{</span><span class="n">event_group_id</span><span class="si">}</span><span class="s2"> because it is not in the event group list provided to the __init__ function&quot;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">event_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">event_group_ids</span> <span class="o">==</span> <span class="n">event_group_id</span><span class="p">)))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="o">.</span><span class="n">show_time</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_event_group_ids</span><span class="p">),</span> <span class="n">i_event_group_id</span><span class="p">)</span>

            <span class="n">event_group</span> <span class="o">=</span> <span class="n">build_NuRadioEvents_from_hdf5</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">,</span> <span class="n">event_indices</span><span class="p">,</span> <span class="n">time_logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="p">)</span>
            <span class="n">event_group</span><span class="o">.</span><span class="n">set_event_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt_time</span><span class="p">)</span>

            <span class="c1"># determine if a particle (neutrinos, or a secondary interaction of a neutrino, or surfaec muons) is simulated</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s2">&quot;weight calc.&quot;</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">particle_mode</span><span class="p">:</span>
                <span class="n">weight</span> <span class="o">=</span> <span class="n">calculate_particle_weight</span><span class="p">(</span><span class="n">event_group</span><span class="p">,</span> <span class="n">event_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s2">&quot;weight calc.&quot;</span><span class="p">)</span>
            <span class="c1"># skip all events where neutrino weights is zero, i.e., do not</span>
            <span class="c1"># simulate neutrino that propagate through the Earth</span>
            <span class="k">if</span> <span class="n">weight</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;minimum_weight_cut&#39;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;neutrino weight is smaller than </span><span class="si">%f</span><span class="s2">, skipping event&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;minimum_weight_cut&#39;</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="c1"># these quantities get computed to apply the distance cut as a function of shower energies</span>
            <span class="c1"># the shower energies of closeby showers will be added as they can constructively interfere</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;distance_cut&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s2">&quot;distance cut&quot;</span><span class="p">)</span>
                <span class="n">shower_energies</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">vertex_positions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">shower</span> <span class="ow">in</span> <span class="n">event_group</span><span class="o">.</span><span class="n">get_sim_showers</span><span class="p">():</span>
                    <span class="n">shower_energies</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">energy</span><span class="p">]])</span>
                    <span class="n">vertex_positions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">shower</span><span class="p">[</span><span class="n">shp</span><span class="o">.</span><span class="n">vertex</span><span class="p">]])</span>
                <span class="n">shower_energies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shower_energies</span><span class="p">)</span>
                <span class="n">vertex_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vertex_positions</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s2">&quot;distance cut&quot;</span><span class="p">)</span>

            <span class="n">output_buffer</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># loop over all stations (each station is treated independently)</span>
            <span class="k">for</span> <span class="n">iSt</span><span class="p">,</span> <span class="n">station_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_station_ids</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;distance_cut&#39;</span><span class="p">]:</span>
                    <span class="c1"># perform a quick cut to reject event group completely if no shower is close enough to the station</span>
                    <span class="n">vertex_distances_to_station</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vertex_positions</span> <span class="o">-</span> <span class="n">station_barycenter</span><span class="p">[</span><span class="n">iSt</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">distance_cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_distance_cut</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">shower_energies</span><span class="p">))</span> <span class="o">+</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">m</span>  <span class="c1"># 100m safety margin is added to account for extent of station around bary center.</span>
                    <span class="k">if</span> <span class="n">vertex_distances_to_station</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">distance_cut</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;event group </span><span class="si">{</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_run_number</span><span class="p">()</span><span class="si">}</span><span class="s2"> is too far away from station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2">, skipping to next station&quot;</span><span class="p">)</span>
                        <span class="c1"># continue</span>

                <span class="n">output_buffer</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">station</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">station</span><span class="o">.</span><span class="n">Station</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>
                <span class="n">sim_station</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">framework</span><span class="o">.</span><span class="n">sim_station</span><span class="o">.</span><span class="n">SimStation</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>
                <span class="n">sim_station</span><span class="o">.</span><span class="n">set_is_neutrino</span><span class="p">()</span>  <span class="c1"># naming not ideal, but this function defines in-ice emission (compared to in-air emission from air showers)</span>
                <span class="n">station</span><span class="o">.</span><span class="n">set_sim_station</span><span class="p">(</span><span class="n">sim_station</span><span class="p">)</span>
                <span class="n">event_group</span><span class="o">.</span><span class="n">set_station</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>

                <span class="c1"># we allow to first only simualte trigger channels. As the trigger channels might be different per station,</span>
                <span class="c1"># we need to determine the channels to simulate first per station</span>
                <span class="n">channel_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(</span><span class="n">station_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trigger_channel_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__trigger_channel_ids</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">channel_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trigger_channel_ids</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">channel_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trigger_channel_ids</span>

                <span class="c1"># loop over all trigger channels</span>
                <span class="n">candidate_station</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">iCh</span><span class="p">,</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channel_ids</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">particle_mode</span><span class="p">:</span>
                        <span class="n">sim_station</span> <span class="o">=</span> <span class="n">calculate_sim_efield</span><span class="p">(</span>
                            <span class="n">showers</span><span class="o">=</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_sim_showers</span><span class="p">(),</span>
                            <span class="n">station_id</span><span class="o">=</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="o">=</span><span class="n">channel_id</span><span class="p">,</span>
                            <span class="n">det</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_propagator</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ice</span><span class="p">,</span>
                            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span>
                            <span class="n">time_logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="p">,</span>
                            <span class="n">min_efield_amplitude</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;min_efield_amplitude&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_efield_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">],</span>
                            <span class="n">distance_cut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_distance_cut</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sim_station</span> <span class="o">=</span> <span class="n">calculate_sim_efield_for_emitter</span><span class="p">(</span>
                            <span class="n">emitters</span><span class="o">=</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_sim_emitters</span><span class="p">(),</span>
                            <span class="n">station_id</span><span class="o">=</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="o">=</span><span class="n">channel_id</span><span class="p">,</span>
                            <span class="n">det</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_propagator</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ice</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span>
                            <span class="n">rnd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rnd</span><span class="p">,</span> <span class="n">antenna_pattern_provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_antenna_pattern_provider</span><span class="p">,</span>
                            <span class="n">min_efield_amplitude</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;min_efield_amplitude&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_efield_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">],</span>
                            <span class="n">time_logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">sim_station</span><span class="o">.</span><span class="n">is_candidate</span><span class="p">():</span>
                        <span class="n">candidate_station</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># skip to next channel if the efield is below the speed cut</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim_station</span><span class="o">.</span><span class="n">get_electric_fields</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eventgroup </span><span class="si">{</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_run_number</span><span class="p">()</span><span class="si">}</span><span class="s2"> Station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2"> &quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sim_station</span><span class="o">.</span><span class="n">get_electric_fields</span><span class="p">())</span><span class="si">}</span><span class="s2"> &quot;</span>
                                    <span class="s2">&quot;efields, skipping to next channel&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># applies the detector response to the electric fields (the antennas are defined</span>
                    <span class="c1"># in the json detector description file)</span>
                    <span class="n">apply_det_response_sim</span><span class="p">(</span>
                        <span class="n">sim_station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_filter_amp</span><span class="p">,</span>
                        <span class="n">event_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt_time</span><span class="p">,</span> <span class="n">time_logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="p">,</span>
                        <span class="n">detector_simulation_part1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_part1</span><span class="p">)</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;adding sim_station to station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2"> for event group &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_run_number</span><span class="p">()</span><span class="si">}</span><span class="s2">, channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">station</span><span class="o">.</span><span class="n">add_sim_station</span><span class="p">(</span><span class="n">sim_station</span><span class="p">)</span>  <span class="c1"># this will add the channels and efields to the existing sim_station object</span>

                <span class="c1"># end channel loop, skip to next event group if all signals are empty (due to speedup cuts)</span>
                <span class="n">sim_station</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">get_sim_station</span><span class="p">()</span>  <span class="c1"># needed to get sim_station object containing all channels and not just the last one.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sim_station</span><span class="o">.</span><span class="n">get_electric_fields</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eventgroup </span><span class="si">{</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_run_number</span><span class="p">()</span><span class="si">}</span><span class="s2"> Station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2"> has &quot;</span>
                                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sim_station</span><span class="o">.</span><span class="n">get_electric_fields</span><span class="p">())</span><span class="si">}</span><span class="s2"> efields, skipping to next station&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">candidate_station</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;skipping station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2"> because all electric fields are below threshold value&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="c1"># group events into events based on signal arrival times</span>
                <span class="n">events</span> <span class="o">=</span> <span class="n">group_into_events</span><span class="p">(</span>
                    <span class="n">station</span><span class="p">,</span> <span class="n">event_group</span><span class="p">,</span> <span class="n">particle_mode</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;split_event_time_diff&#39;</span><span class="p">],</span>
                    <span class="n">time_logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="p">)</span>

                <span class="n">evt_group_triggered</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
                    <span class="n">station</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">get_station</span><span class="p">()</span>
                    <span class="n">apply_det_response</span><span class="p">(</span>
                        <span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_filter_amp</span><span class="p">,</span>
                        <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_channel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_noiseless_channels</span><span class="p">,</span>
                        <span class="n">time_logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="p">,</span>
                        <span class="n">channel_ids</span><span class="o">=</span><span class="n">channel_ids</span><span class="p">,</span>
                        <span class="n">detector_simulation_part2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_part2</span><span class="p">)</span>

                    <span class="c1"># calculate trigger</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="o">.</span><span class="n">start_time</span><span class="p">(</span><span class="s2">&quot;trigger&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_trigger</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;event </span><span class="si">{</span><span class="n">evt</span><span class="o">.</span><span class="n">get_run_number</span><span class="p">()</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">evt</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span><span class="si">}</span><span class="s2"> tiggered: </span><span class="si">{</span><span class="n">evt</span><span class="o">.</span><span class="n">get_station</span><span class="p">()</span><span class="o">.</span><span class="n">has_triggered</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="o">.</span><span class="n">stop_time</span><span class="p">(</span><span class="s2">&quot;trigger&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">evt</span><span class="o">.</span><span class="n">get_station</span><span class="p">()</span><span class="o">.</span><span class="n">has_triggered</span><span class="p">():</span>
                        <span class="k">continue</span>

                    <span class="n">channelReadoutWindowCutter</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">)</span>
                    <span class="n">evt_group_triggered</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">output_buffer</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">evt</span><span class="o">.</span><span class="n">get_id</span><span class="p">()]</span> <span class="o">=</span> <span class="n">evt</span>
                <span class="c1"># end event loop</span>

                <span class="c1"># Only simulate the remaining channels &amp; store the event when the event triggered.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">evt_group_triggered</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># now simulate non-trigger channels</span>
                <span class="c1"># we loop through all non-trigger channels and simulate the electric fields for all showers.</span>
                <span class="c1"># then we apply the detector response to the electric fields and find the event in which they will be visible in the readout window</span>
                <span class="n">non_trigger_channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(</span><span class="n">station_id</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">channel_ids</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_trigger_channels</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Simulating non-trigger channels for station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">non_trigger_channels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">iCh</span><span class="p">,</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">non_trigger_channels</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">particle_mode</span><span class="p">:</span>
                            <span class="n">sim_station</span> <span class="o">=</span> <span class="n">calculate_sim_efield</span><span class="p">(</span>
                                <span class="n">showers</span><span class="o">=</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_sim_showers</span><span class="p">(),</span>
                                <span class="n">station_id</span><span class="o">=</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="o">=</span><span class="n">channel_id</span><span class="p">,</span>
                                <span class="n">det</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_propagator</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ice</span><span class="p">,</span>
                                <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span>
                                <span class="n">time_logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="p">,</span>
                                <span class="n">min_efield_amplitude</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;min_efield_amplitude&#39;</span><span class="p">])</span>
                                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_efield_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">],</span>
                                <span class="n">distance_cut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_distance_cut</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sim_station</span> <span class="o">=</span> <span class="n">calculate_sim_efield_for_emitter</span><span class="p">(</span>
                                <span class="n">emitters</span><span class="o">=</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_sim_emitters</span><span class="p">(),</span>
                                <span class="n">station_id</span><span class="o">=</span><span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="o">=</span><span class="n">channel_id</span><span class="p">,</span>
                                <span class="n">det</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">propagator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_propagator</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ice</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span>
                                <span class="n">rnd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_rnd</span><span class="p">,</span> <span class="n">antenna_pattern_provider</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_antenna_pattern_provider</span><span class="p">,</span>
                                <span class="n">min_efield_amplitude</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;speedup&#39;</span><span class="p">][</span><span class="s1">&#39;min_efield_amplitude&#39;</span><span class="p">])</span>
                                    <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_efield_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel_id</span><span class="p">],</span>
                                <span class="n">time_logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="p">)</span>

                        <span class="c1"># skip to next channel if the efield is below the speed cut</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">sim_station</span><span class="o">.</span><span class="n">get_electric_fields</span><span class="p">():</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Eventgroup </span><span class="si">{</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_run_number</span><span class="p">()</span><span class="si">}</span><span class="s2"> Station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2"> channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2"> has &quot;</span>
                                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">sim_station</span><span class="o">.</span><span class="n">get_electric_fields</span><span class="p">())</span><span class="si">}</span><span class="s2"> efields, skipping to next channel&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="c1"># applies the detector response to the electric fields (the antennas are defined</span>
                        <span class="c1"># in the json detector description file)</span>
                        <span class="n">apply_det_response_sim</span><span class="p">(</span>
                            <span class="n">sim_station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_filter_amp</span><span class="p">,</span>
                            <span class="n">event_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_evt_time</span><span class="p">,</span> <span class="n">time_logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__time_logger</span><span class="p">,</span>
                            <span class="n">detector_simulation_part1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">detector_simulation_part1</span><span class="p">)</span>

                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Adding sim_station to station </span><span class="si">{</span><span class="n">station_id</span><span class="si">}</span><span class="s2"> for event group &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">event_group</span><span class="o">.</span><span class="n">get_run_number</span><span class="p">()</span><span class="si">}</span><span class="s2">, channel </span><span class="si">{</span><span class="n">channel_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">station</span><span class="o">.</span><span class="n">add_sim_station</span><span class="p">(</span><span class="n">sim_station</span><span class="p">)</span>  <span class="c1"># this will add the channels and efields to the existing sim_station object</span>

                        <span class="c1"># The non-triggered channels were simulated using the efieldToVoltageConverterPerEfield</span>
                        <span class="c1"># (notice the &quot;PerEfield&quot; in the name). This means that each electric field was converted to</span>
                        <span class="c1"># a sim channel. Now we still have to add together all sim channels associated with one &quot;physical&quot;</span>
                        <span class="c1"># channel. Furthermore we have to cut out the correct readout window. For the trigger channels</span>
                        <span class="c1"># this is done with the channelReadoutWindowCutter, here we have to do it manually.</span>
                        <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="n">output_buffer</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                            <span class="k">for</span> <span class="n">sim_channel</span> <span class="ow">in</span> <span class="n">sim_station</span><span class="o">.</span><span class="n">get_channels_by_channel_id</span><span class="p">(</span><span class="n">channel_id</span><span class="p">):</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">station</span><span class="o">.</span><span class="n">has_channel</span><span class="p">(</span><span class="n">sim_channel</span><span class="o">.</span><span class="n">get_id</span><span class="p">()):</span>
                                    <span class="c1"># For each physical channel we first create a &quot;empty&quot; trace (all zeros)</span>
                                    <span class="c1"># with the start time and length ....</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_empty_channel</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>

                                <span class="n">channel</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">sim_channel</span><span class="o">.</span><span class="n">get_id</span><span class="p">())</span>
                                <span class="c1"># ... and now add the sim channel to the correct window defined by the &quot;empty trace&quot;</span>
                                <span class="c1"># At this point the traces are noiseless, hence, we do not have to raise an error.</span>
                                <span class="n">channel</span><span class="o">.</span><span class="n">add_to_trace</span><span class="p">(</span><span class="n">sim_channel</span><span class="p">,</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">evt</span> <span class="ow">in</span> <span class="n">output_buffer</span><span class="p">[</span><span class="n">station_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">station</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">get_station</span><span class="p">()</span>
                    <span class="c1"># we might not have a channel object in case there was no ray tracing solution</span>
                    <span class="c1"># to this channel, or if the timing did not match the readout window. In this</span>
                    <span class="c1"># case we need to create a channel object and add it to the station</span>
                    <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="n">non_trigger_channels</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">station</span><span class="o">.</span><span class="n">has_channel</span><span class="p">(</span><span class="n">channel_id</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_add_empty_channel</span><span class="p">(</span><span class="n">station</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">)</span>

                    <span class="c1"># The only thing left is to add noise to the non-trigger traces</span>
                    <span class="c1"># we need to do it a bit differently than for the trigger traces,</span>
                    <span class="c1"># because we need to add noise to traces where the amplifier response</span>
                    <span class="c1"># was already applied to.</span>
                    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;noise&#39;</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">add_filtered_noise_to_channels</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">non_trigger_channels</span><span class="p">)</span>

                    <span class="n">channelSignalReconstructor</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_set_event_station_parameters</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputfilenameNuRadioReco</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># downsample traces to detector sampling rate to save file size</span>
                        <span class="n">sampling_rate_detector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">get_sampling_frequency</span><span class="p">(</span>
                            <span class="n">station_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">get_channel_ids</span><span class="p">(</span><span class="n">station_id</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;channel_traces&#39;</span><span class="p">]:</span>
                            <span class="n">channelResampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate_detector</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;electric_field_traces&#39;</span><span class="p">]:</span>
                            <span class="n">electricFieldResampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                <span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate_detector</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;sim_channel_traces&#39;</span><span class="p">]:</span>
                            <span class="n">channelResampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                <span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="o">.</span><span class="n">get_sim_station</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate_detector</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;sim_electric_field_traces&#39;</span><span class="p">]:</span>
                            <span class="n">electricFieldResampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                                <span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="o">.</span><span class="n">get_sim_station</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">sampling_rate_detector</span><span class="p">)</span>

                        <span class="n">output_mode</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s1">&#39;Channels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;channel_traces&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;ElectricFields&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;electric_field_traces&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;SimChannels&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;sim_channel_traces&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;SimElectricFields&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;sim_electric_field_traces&#39;</span><span class="p">]}</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__write_detector</span><span class="p">:</span>
                            <span class="n">eventWriter</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">output_mode</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">eventWriter</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">output_mode</span><span class="p">)</span>

                    <span class="n">remove_all_traces</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>  <span class="c1"># remove all traces to save memory</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_output_writer_hdf5</span><span class="o">.</span><span class="n">add_event_group</span><span class="p">(</span><span class="n">output_buffer</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_outputfilenameNuRadioReco</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eventWriter</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;closing nur file&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_output_writer_hdf5</span><span class="o">.</span><span class="n">calculate_Veff</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_output_writer_hdf5</span><span class="o">.</span><span class="n">write_output_file</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No events were triggered. Writing empty HDF5 output file.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_output_writer_hdf5</span><span class="o">.</span><span class="n">write_empty_output_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">)</span></div>


<div class="viewcode-block" id="simulation.add_filtered_noise_to_channels">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.simulation.add_filtered_noise_to_channels">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_filtered_noise_to_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel_ids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add noise to the traces of the channels in the event.</span>
<span class="sd">        This function is used to add noise to the traces of the non-trigger channels.</span>
<span class="sd">        The traces of the non-trigger channels already have the detector response applied to them.</span>
<span class="sd">        Hence we add &quot;filtered&quot; noise, i.e., noise which is based through the same filter seperatly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">station_id</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="n">channel_ids</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">get_channel</span><span class="p">(</span><span class="n">channel_id</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">channel_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noiseless_channels</span><span class="p">[</span><span class="n">station_id</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">ff</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_frequencies</span><span class="p">()</span>
            <span class="n">filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">iter_modules</span><span class="p">(</span><span class="n">station_id</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;get_filter&quot;</span><span class="p">):</span>
                    <span class="n">filt</span> <span class="o">*=</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_filter</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">station_id</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">noise</span> <span class="o">=</span> <span class="n">channelGenericNoiseAdder</span><span class="o">.</span><span class="n">bandlimited_noise_from_spectrum</span><span class="p">(</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">get_number_of_samples</span><span class="p">(),</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_sampling_rate</span><span class="p">(),</span>
                <span class="n">spectrum</span><span class="o">=</span><span class="n">filt</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_channel</span><span class="p">[</span><span class="n">station</span><span class="o">.</span><span class="n">get_id</span><span class="p">()][</span><span class="n">channel_id</span><span class="p">],</span>
                <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;rayleigh&#39;</span><span class="p">,</span> <span class="n">time_domain</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">channel</span><span class="o">.</span><span class="n">set_frequency_spectrum</span><span class="p">(</span><span class="n">channel</span><span class="o">.</span><span class="n">get_frequency_spectrum</span><span class="p">()</span> <span class="o">+</span> <span class="n">noise</span><span class="p">,</span> <span class="n">channel</span><span class="o">.</span><span class="n">get_sampling_rate</span><span class="p">())</span></div>



    <span class="k">def</span><span class="w"> </span><span class="nf">_add_empty_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">channel_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Adds a channel with an empty trace (all zeros) to the station with the correct length and trace_start_time &quot;&quot;&quot;</span>
        <span class="n">trigger</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">get_primary_trigger</span><span class="p">()</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">NuRadioReco</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">channelReadoutWindowCutter</span><span class="o">.</span><span class="n">get_empty_channel</span><span class="p">(</span>
            <span class="n">station</span><span class="o">.</span><span class="n">get_id</span><span class="p">(),</span> <span class="n">channel_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">trigger</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">])</span>

        <span class="n">station</span><span class="o">.</span><span class="n">add_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_set_event_station_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Store generator / simulation attributes in the event &quot;&quot;&quot;</span>
        <span class="c1"># save RMS and bandwidth to channel object</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">genattrs</span><span class="o">.</span><span class="n">Vrms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms</span><span class="p">)</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">genattrs</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">])</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">genattrs</span><span class="o">.</span><span class="n">Tnoise</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noise_temp</span><span class="p">)</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">genattrs</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">,</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
        <span class="n">station</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">get_station</span><span class="p">()</span>
        <span class="n">station_id</span> <span class="o">=</span> <span class="n">station</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">station</span><span class="o">.</span><span class="n">iter_channels</span><span class="p">():</span>
            <span class="n">channel</span><span class="p">[</span><span class="n">chp</span><span class="o">.</span><span class="n">Vrms_NuRadioMC_simulation</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel</span><span class="o">.</span><span class="n">get_id</span><span class="p">()]</span>
            <span class="n">channel</span><span class="p">[</span><span class="n">chp</span><span class="o">.</span><span class="n">bandwidth_NuRadioMC_simulation</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel</span><span class="o">.</span><span class="n">get_id</span><span class="p">()]</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__trigger_channel_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trigger_channel_ids</span> <span class="ow">and</span>
                <span class="n">channel</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_trigger_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">]):</span>
                <span class="n">channel</span><span class="p">[</span><span class="n">chp</span><span class="o">.</span><span class="n">Vrms_trigger_NuRadioMC_simulation</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms_per_trigger_channel</span><span class="p">[</span><span class="n">station_id</span><span class="p">][</span><span class="n">channel</span><span class="o">.</span><span class="n">get_id</span><span class="p">()]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_is_in_fiducial_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Checks if pos is in fiducial volume &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">check_attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fiducial_zmin&#39;</span><span class="p">,</span> <span class="s1">&#39;fiducial_zmax&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">check_attr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Fiducial volume not defined. Return True&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s2">&quot;fiducial_zmin&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s2">&quot;fiducial_zmax&quot;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;fiducial_rmax&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">:</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s2">&quot;fiducial_rmin&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">radius</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s2">&quot;fiducial_rmax&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;fiducial_xmax&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s2">&quot;fiducial_xmin&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s2">&quot;fiducial_xmax&quot;</span><span class="p">]</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s2">&quot;fiducial_ymin&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s2">&quot;fiducial_ymax&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not contruct fiducial volume from input file.&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_vertex_times</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="s1">&#39;vertex_times&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warn_msg</span> <span class="o">=</span> <span class="s1">&#39;The input file does not include vertex times. &#39;</span>
            <span class="n">warn_msg</span> <span class="o">+=</span> <span class="s1">&#39;Vertices from the same event will not be time-ordered.&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">warn_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="simulation.get_Vrms">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.simulation.get_Vrms">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_Vrms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Vrms</span></div>


<div class="viewcode-block" id="simulation.get_sampling_rate">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.simulation.get_sampling_rate">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_sampling_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_config</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="simulation.get_bandwidth">
<a class="viewcode-back" href="../../../NuRadioMC/apidoc/NuRadioMC.simulation.simulation.html#NuRadioMC.simulation.simulation.simulation.get_bandwidth">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_bandwidth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bandwidth</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_if_was_pre_simulated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        checks if the same detector was simulated before (then we can save the ray tracing part)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_was_pre_simulated</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s1">&#39;detector&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="p">,</span> <span class="n">detector</span><span class="o">.</span><span class="n">rnog_detector</span><span class="o">.</span><span class="n">Detector</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_det</span><span class="o">.</span><span class="n">export_as_string</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_was_pre_simulated</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_detectorfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fdet</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fdet</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fin_attrs</span><span class="p">[</span><span class="s1">&#39;detector&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_was_pre_simulated</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_was_pre_simulated</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="s2">&quot;the simulation was already performed with the same detector&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_was_pre_simulated</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_bandwidth_per_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This variable `_bandwidth_per_channel` is deprecated. &quot;</span>
                      <span class="s2">&quot;Please use `integrated_channel_response` instead.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span>

    <span class="nd">@_bandwidth_per_channel</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_bandwidth_per_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This variable `_bandwidth_per_channel` is deprecated. &quot;</span>
                        <span class="s2">&quot;Please use `integrated_channel_response` instead.&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrated_channel_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span>

    <span class="nd">@integrated_channel_response</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">integrated_channel_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_integrated_channel_response</span> <span class="o">=</span> <span class="n">value</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, The NuRadio Group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>